{
    "tables": [
        {
            "name": "bank_alternative_names",
            "sql": "CREATE TABLE bank_alternative_names (\r\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n            bank_id INTEGER NOT NULL,\r\n            alternative_name TEXT NOT NULL,\r\n            normalized_name TEXT NOT NULL,\r\n            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n            FOREIGN KEY (bank_id) REFERENCES banks(id) ON DELETE CASCADE\r\n        )"
        },
        {
            "name": "banks",
            "sql": "CREATE TABLE \"banks\"(\n  id,\n  arabic_name TEXT,\n  english_name TEXT,\n  short_name TEXT,\n  created_at NUM,\n  updated_at NUM,\n  department TEXT,\n  address_line1 TEXT,\n  contact_email TEXT\n)"
        },
        {
            "name": "guarantee_attachments",
            "sql": "CREATE TABLE guarantee_attachments (\r\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n    guarantee_id INTEGER NOT NULL,\r\n    file_name TEXT NOT NULL,\r\n    file_path TEXT NOT NULL,\r\n    file_size INTEGER,\r\n    file_type TEXT,\r\n    uploaded_by TEXT DEFAULT 'system',\r\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n    FOREIGN KEY (guarantee_id) REFERENCES guarantees(id) ON DELETE CASCADE\r\n)"
        },
        {
            "name": "guarantee_decisions",
            "sql": "CREATE TABLE \"guarantee_decisions\" (\r\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n    guarantee_id INTEGER NOT NULL,\r\n    \r\n    -- Status & Lock\r\n    status TEXT NOT NULL DEFAULT 'pending',\r\n    is_locked BOOLEAN DEFAULT 0,\r\n    locked_reason TEXT,\r\n    \r\n    -- Decisions\r\n    supplier_id INTEGER,\r\n    bank_id INTEGER,\r\n    \r\n    -- Decision Metadata\r\n    decision_source TEXT DEFAULT 'manual',\r\n    confidence_score REAL,\r\n    decided_at DATETIME,\r\n    decided_by TEXT,\r\n    \r\n    -- Last modification (distinct from decision)\r\n    last_modified_at DATETIME,\r\n    last_modified_by TEXT,\r\n    manual_override BOOLEAN DEFAULT 0,\r\n    \r\n    -- Timestamps\r\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n    \r\n    -- Active Action (UI cache)\r\n    active_action TEXT NULL,\r\n    active_action_set_at TEXT NULL,\r\n    \r\n    -- Foreign Keys\r\n    FOREIGN KEY (guarantee_id) REFERENCES guarantees(id) ON DELETE CASCADE,\r\n    FOREIGN KEY (supplier_id) REFERENCES \"suppliers_old\"(id) ON DELETE SET NULL,\r\n    FOREIGN KEY (bank_id) REFERENCES banks(id) ON DELETE SET NULL,\r\n    \r\n    -- Constraints\r\n    UNIQUE(guarantee_id)\r\n)"
        },
        {
            "name": "guarantee_history",
            "sql": "CREATE TABLE \"guarantee_history\" (\r\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n    guarantee_id INTEGER NOT NULL,\r\n    event_type TEXT NOT NULL,\r\n    event_subtype TEXT,\r\n    snapshot_data TEXT,\r\n    event_details TEXT,\r\n    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n    created_by TEXT, letter_snapshot TEXT NULL,\r\n    \r\n    FOREIGN KEY (guarantee_id) REFERENCES guarantees(id) ON DELETE CASCADE\r\n)"
        },
        {
            "name": "guarantee_notes",
            "sql": "CREATE TABLE guarantee_notes (\r\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n    guarantee_id INTEGER NOT NULL,\r\n    content TEXT NOT NULL,\r\n    created_by TEXT DEFAULT 'system',\r\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n    updated_at TIMESTAMP,\r\n    FOREIGN KEY (guarantee_id) REFERENCES guarantees(id) ON DELETE CASCADE\r\n)"
        },
        {
            "name": "guarantees",
            "sql": "CREATE TABLE guarantees (\r\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n    guarantee_number TEXT NOT NULL,\r\n    \r\n    -- Raw Data (JSON - immutable source of truth)\r\n    raw_data JSON NOT NULL,\r\n    \/*\r\n    Example structure:\r\n    {\r\n      \"supplier\": \"K.F.S.H\",\r\n      \"bank\": \"الراجحي\",\r\n      \"amount\": \"500000.00\",\r\n      \"issue_date\": \"2024-01-15\",\r\n      \"expiry_date\": \"2025-01-15\",\r\n      \"document_reference\": \"C-2024-100\",\r\n      \"related_to\": \"contract\",  -- or \"purchase_order\"\r\n      \"type\": \"FINAL\",\r\n      \"comment\": null\r\n    }\r\n    *\/\r\n    \r\n    -- Import Tracking (per guarantee)\r\n    import_source TEXT NOT NULL,  -- 'excel', 'smart_paste', 'manual'\r\n    imported_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n    imported_by TEXT, normalized_supplier_name TEXT,  -- Future: username\r\n    \r\n    -- Constraints\r\n    UNIQUE(guarantee_number)\r\n)"
        },
        {
            "name": "learning_confirmations",
            "sql": "CREATE TABLE learning_confirmations (\r\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n    raw_supplier_name TEXT NOT NULL,\r\n    supplier_id INTEGER NOT NULL,\r\n    confidence INTEGER,\r\n    matched_anchor TEXT,\r\n    anchor_type TEXT,\r\n    action TEXT CHECK(action IN ('confirm', 'reject')),\r\n    decision_time_seconds REAL,\r\n    guarantee_id INTEGER,\r\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, count INTEGER DEFAULT 1, updated_at DATETIME, normalized_supplier_name TEXT,\r\n    FOREIGN KEY (supplier_id) REFERENCES \"suppliers_old\"(id)\r\n)"
        },
        {
            "name": "supplier_alternative_names",
            "sql": "CREATE TABLE supplier_alternative_names (\r\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n    supplier_id INTEGER NOT NULL,\r\n    alternative_name TEXT NOT NULL,\r\n    normalized_name TEXT,\r\n    source TEXT DEFAULT 'manual',\r\n    usage_count INTEGER DEFAULT 1,\r\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n    FOREIGN KEY (supplier_id) REFERENCES \"suppliers_old\"(id) ON DELETE CASCADE\r\n)"
        },
        {
            "name": "supplier_decisions_log",
            "sql": "CREATE TABLE supplier_decisions_log (\r\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n    guarantee_id INTEGER NOT NULL,\r\n    \r\n    -- Input\r\n    raw_input TEXT NOT NULL,\r\n    normalized_input TEXT NOT NULL,\r\n    \r\n    -- Decision\r\n    chosen_supplier_id INTEGER NOT NULL,\r\n    chosen_supplier_name TEXT NOT NULL,\r\n    \r\n    -- Context\r\n    decision_source TEXT NOT NULL CHECK(decision_source IN ('manual', 'ai_quick', 'ai_assisted', 'propagated', 'auto_match')),\r\n    confidence_score REAL,\r\n    was_top_suggestion BOOLEAN DEFAULT 0,  -- For analysis\r\n    \r\n    -- Timestamps\r\n    decided_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n    \r\n    FOREIGN KEY (guarantee_id) REFERENCES guarantees(id) ON DELETE CASCADE,\r\n    FOREIGN KEY (chosen_supplier_id) REFERENCES \"suppliers_old\"(id) ON DELETE CASCADE\r\n)"
        },
        {
            "name": "supplier_learning_cache",
            "sql": "CREATE TABLE supplier_learning_cache (\r\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n    normalized_input TEXT NOT NULL,\r\n    supplier_id INTEGER NOT NULL,\r\n    \r\n    -- Scoring Components (from ScoringConfig)\r\n    fuzzy_score REAL DEFAULT 0.0 CHECK(fuzzy_score >= 0.0 AND fuzzy_score <= 1.0),\r\n    source_weight INTEGER DEFAULT 0,\r\n    usage_count INTEGER DEFAULT 0,\r\n    block_count INTEGER DEFAULT 0,\r\n    \r\n    -- Computed Scores (GENERATED columns for performance)\r\n    total_score REAL GENERATED ALWAYS AS (\r\n        (fuzzy_score * 100) + \r\n        source_weight + \r\n        CASE \r\n            WHEN (usage_count * 15) > 75 THEN 75\r\n            ELSE (usage_count * 15)\r\n        END\r\n    ) STORED,\r\n    \r\n    effective_score REAL GENERATED ALWAYS AS (\r\n        (fuzzy_score * 100) + \r\n        source_weight + \r\n        CASE \r\n            WHEN (usage_count * 15) > 75 THEN 75\r\n            ELSE (usage_count * 15)\r\n        END - \r\n        (block_count * 50)\r\n    ) STORED,\r\n    \r\n    star_rating INTEGER GENERATED ALWAYS AS (\r\n        CASE\r\n            WHEN ((fuzzy_score * 100) + source_weight + \r\n                  CASE WHEN (usage_count * 15) > 75 THEN 75 ELSE (usage_count * 15) END) >= 200\r\n            THEN 3\r\n            WHEN ((fuzzy_score * 100) + source_weight + \r\n                  CASE WHEN (usage_count * 15) > 75 THEN 75 ELSE (usage_count * 15) END) >= 120\r\n            THEN 2\r\n            ELSE 1\r\n        END\r\n    ) STORED,\r\n    \r\n    -- Metadata\r\n    last_used_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n    \r\n    FOREIGN KEY (supplier_id) REFERENCES \"suppliers_old\"(id) ON DELETE CASCADE,\r\n    UNIQUE(normalized_input, supplier_id)\r\n)"
        },
        {
            "name": "suppliers",
            "sql": "CREATE TABLE suppliers (\r\n        id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n        official_name TEXT NOT NULL,\r\n        display_name TEXT,\r\n        normalized_name TEXT NOT NULL,\r\n        supplier_normalized_key TEXT,\r\n        is_confirmed INTEGER DEFAULT 0,\r\n        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,\r\n        english_name TEXT\r\n    )"
        }
    ],
    "guarantees_columns": [
        {
            "cid": 0,
            "name": "id",
            "type": "INTEGER",
            "notnull": 0,
            "dflt_value": null,
            "pk": 1
        },
        {
            "cid": 1,
            "name": "guarantee_number",
            "type": "TEXT",
            "notnull": 1,
            "dflt_value": null,
            "pk": 0
        },
        {
            "cid": 2,
            "name": "raw_data",
            "type": "JSON",
            "notnull": 1,
            "dflt_value": null,
            "pk": 0
        },
        {
            "cid": 3,
            "name": "import_source",
            "type": "TEXT",
            "notnull": 1,
            "dflt_value": null,
            "pk": 0
        },
        {
            "cid": 4,
            "name": "imported_at",
            "type": "DATETIME",
            "notnull": 1,
            "dflt_value": "CURRENT_TIMESTAMP",
            "pk": 0
        },
        {
            "cid": 5,
            "name": "imported_by",
            "type": "TEXT",
            "notnull": 0,
            "dflt_value": null,
            "pk": 0
        },
        {
            "cid": 6,
            "name": "normalized_supplier_name",
            "type": "TEXT",
            "notnull": 0,
            "dflt_value": null,
            "pk": 0
        }
    ],
    "import_sources": [
        {
            "import_source": "excel_20260105_143502",
            "imported_at": "2026-01-05 14:35:02"
        }
    ],
    "import_source_groups": [
        {
            "import_source": "excel_20260105_143502",
            "count": 21,
            "first": "2026-01-05 14:35:02",
            "last": "2026-01-05 14:35:02"
        }
    ],
    "history_columns": [
        {
            "cid": 0,
            "name": "id",
            "type": "INTEGER",
            "notnull": 0,
            "dflt_value": null,
            "pk": 1
        },
        {
            "cid": 1,
            "name": "guarantee_id",
            "type": "INTEGER",
            "notnull": 1,
            "dflt_value": null,
            "pk": 0
        },
        {
            "cid": 2,
            "name": "event_type",
            "type": "TEXT",
            "notnull": 1,
            "dflt_value": null,
            "pk": 0
        },
        {
            "cid": 3,
            "name": "event_subtype",
            "type": "TEXT",
            "notnull": 0,
            "dflt_value": null,
            "pk": 0
        },
        {
            "cid": 4,
            "name": "snapshot_data",
            "type": "TEXT",
            "notnull": 0,
            "dflt_value": null,
            "pk": 0
        },
        {
            "cid": 5,
            "name": "event_details",
            "type": "TEXT",
            "notnull": 0,
            "dflt_value": null,
            "pk": 0
        },
        {
            "cid": 6,
            "name": "created_at",
            "type": "DATETIME",
            "notnull": 0,
            "dflt_value": "CURRENT_TIMESTAMP",
            "pk": 0
        },
        {
            "cid": 7,
            "name": "created_by",
            "type": "TEXT",
            "notnull": 0,
            "dflt_value": null,
            "pk": 0
        },
        {
            "cid": 8,
            "name": "letter_snapshot",
            "type": "TEXT",
            "notnull": 0,
            "dflt_value": null,
            "pk": 0
        }
    ],
    "event_types": [
        {
            "event_type": "import",
            "event_subtype": "excel",
            "count": 269
        },
        {
            "event_type": "auto_matched",
            "event_subtype": "bank_match",
            "count": 267
        },
        {
            "event_type": "status_change",
            "event_subtype": "status_change",
            "count": 94
        },
        {
            "event_type": "modified",
            "event_subtype": "manual_edit",
            "count": 50
        },
        {
            "event_type": "auto_matched",
            "event_subtype": "ai_match",
            "count": 49
        },
        {
            "event_type": "modified",
            "event_subtype": "extension",
            "count": 20
        },
        {
            "event_type": "import",
            "event_subtype": "smart_paste",
            "count": 2
        },
        {
            "event_type": "modified",
            "event_subtype": "reduction",
            "count": 2
        },
        {
            "event_type": "release",
            "event_subtype": "release",
            "count": 1
        }
    ],
    "batch_session_columns": [
        {
            "table": "guarantees",
            "column": "import_source",
            "type": "TEXT"
        },
        {
            "table": "guarantees",
            "column": "imported_at",
            "type": "DATETIME"
        },
        {
            "table": "guarantees",
            "column": "imported_by",
            "type": "TEXT"
        }
    ]
}