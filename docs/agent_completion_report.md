# تقرير الإكمال النهائي لوكيل BGL3 (الحالة + المتبقي + الخطة التنفيذية)

**التاريخ:** 2026-02-07  
**الهدف النهائي:** وكيل تشخيص واستكشاف مستقل ومترابط حلقيًا يقوم بـ
اقتراح → تنفيذ (Sandbox/Canary) → قياس أثر → تحديث نية/قواعد
بشكل موثوق وشفاف، مع تغطية سيناريوهات منهجية وفهم واجهة أعمق وتفسير قرار واضح.

---

## 0) ملخص تنفيذي سريع

**ما هو موجود بالفعل (مختصر):**
- طبقة تشغيل السيناريوهات UI/API مع حركة بشرية منظمة وقياسات زمنية.
- رصد أحداث runtime_events + learned_events + نتائج outcomes.
- قرار حتمي مبدئي (Decision Engine) + قواعد مجال + تفسير القرار.
- طبقة فرضيات (Hypothesis) + إشارات outcomes.
- قياس UI semantic وتغيّر المعنى وربطه بالقرار.
- أهداف طويلة المدى + كاناري/رجوع للتغييرات المطبقة.
- لوحة تحكم وتقارير تشخيصية (Report/Dashboard).

**ما الذي لا يزال ناقصًا ليُعتبر الوكيل “كاملاً”:**
1) حلقة مغلقة 100% (اقتراح → تنفيذ → قياس → تحديث قواعد/نية) **بلا تدخّل يدوي** في بيئة الوكيل.
2) **قياس سببي متقدم** (counterfactual/attribution) بدل الارتباط السطحي.
3) **نموذج فهم تدفّق/سلوك UI** وليس مجرد عناصر وsemantics.
4) **تغطية سيناريوهات منهجية** مع مقاييس فجوات وتوليد فجوات تلقائيًا.
5) **تنقية المعرفة** مع ترجيح وحل تعارض معرفي مضبوط.
6) **نشر آمن متدرّج** على مستوى النظام (canary/rollback) للسيناريوهات والقرارات كذلك، وليس فقط تغييرات الكود.
7) **شرح قرار موجه للمستخدم النهائي** (سبب + بدائل + أثر متوقع) في لوحة التحكم بشكل قابل للاستخدام.
8) **ضبط الاستقرار التشغيلي** (timeouts, watchdogs, resource guards) حتى لا يتوقف التنفيذ أو يتكرر بلا نهاية.

---

## 1) الوضع الحالي بالتفصيل (ما تم بناؤه فعلاً)

### 1.1 القياس والرصد
- `runtime_events` في `knowledge.db` + تجميعات outcomes.
- قياسات UX (Move→Click, Click→DOM).
- رصد تغيّر UI semantic وتسجيله.

### 1.2 القرار والحوكمة
- Decision Engine مع تفسير قرار.
- Domain Rules + Runtime Safety.
- Authority Gate للقرارات والكتابة.

### 1.3 التعلم / الفرضيات
- Hypothesis pipeline يربط outcomes بعلاقات (supports/contradicts).
- إشارات learning feedback محدودة (تعديل عتبات بسيطة).

### 1.4 الأهداف طويلة المدى
- `long_term_goals.py` يولّد أهدافًا ممتدة الزمن.

### 1.5 الاستكشاف UI
- Browser Sensor + Motor + Policy.
- Semantic snapshots + delta.
- تدفق UI محدود (ليس نموذج سلوك كامل).

### 1.6 النشر الآمن
- Canary + rollback للـpatches (code changes).

---

## 2) الفجوات المتبقية (ما ينقص تحديدًا)

### A) حلقة التطوير الذاتي المغلقة (Self-Loop)
**الحالة:** جزئية  
**النقص:**  
1) لا يوجد مسار آلي كامل يحوّل نتيجة فشل إلى Proposal ثم Patch ثم قياس أثر ثم تحديث قواعد/نية بدون تدخل.  
2) لا توجد قواعد واضحة لتحديد متى يحق للوكيل تعديل نية/قواعده في بيئة الوكيل (sandbox) دون موافقة.

### B) القياس السببي الحقيقي (Attribution + Counterfactual)
**الحالة:** يوجد attribution أولي ولكن سطحي  
**النقص:**  
1) عدم وجود مقارنة مضادة (counterfactual) لتحديد ما إذا كان التغيّر سببه الوكيل أو تغيّر خارجي.  
2) عدم وجود “Design of Experiments” بسيط (A/B داخلي).

### C) فهم UI كتدفّق/سلوك
**الحالة:** يوجد semantic map  
**النقص:**  
1) لا يوجد Flow Model يربط “الصفحة → الخطوة → النتيجة” على مستوى المهمة.  
2) لا يوجد Model للسلوك (State Machine) يمكّن التوقع أو الكشف المبكر للتوقف.

### D) تغطية السيناريوهات والفجوات
**الحالة:** موجودة جزئيًا  
**ما تم فعليًا:**  
- توليد `analysis/coverage.json` + تحليل فجوات تدفّقات `docs/flows/` عبر Guardian.  
- توليد سيناريوهات فجوة تلقائيًا في `.bgl_core/brain/scenarios/generated/`.  
**النقص:**  
1) تغطية الفجوات غير مرتبطة بعدُ بسياسة ترتيب/جدولة واضحة.  
2) تغطية UI “المهام الحرجة” ما زالت غير مقاسة كـ task-level coverage.  
3) لا يوجد Scoring/أولوية للفجوات يربط المخاطر أو أثر الأعمال مباشرة.

### E) تنقية المعرفة وحل التضارب
**الحالة:** Knowledge curation موجودة مع اكتشاف تضارب  
**النقص:**  
1) لا يوجد نظام ترجيح متطور للأدلة عبر الزمن (aging/credibility).  
2) لا يوجد قرار آلي نهائي لترجيح التضارب بناءً على نتائج تكرارية متعددة.

### F) نشر آمن للسيناريوهات والقرارات
**الحالة:** canary لملفات الكود فقط  
**النقص:**  
1) لا يوجد Canary/rollback للسيناريوهات/القرارات/السياسات.  
2) لا يوجد Shadow Run للسيناريوهات على بيئة مماثلة قبل التعميم.

### G) الشرح للمستخدم النهائي
**الحالة:** تفسير قرار موجود في التقرير  
**النقص:**  
1) لا يظهر بوضوح في لوحة التحكم كـ “سبب + بدائل + أثر”.  
2) لا يوجد ربط مباشر بين قرار والـOutcome في عرض المستخدم.

### H) الاستقرار التشغيلي
**الحالة:** توجد إدارة بسيطة  
**النقص:**  
1) لا توجد Timeouts واضحة على كل خطوة سيناريو.  
2) توقف السيناريوهات عند صفحة ثابتة بدون إشارة واضحة للسبب.

---

## 3) الخطة التنفيذية الكاملة (مرحلية + مترابطة)

### المرحلة 1 — تثبيت السجل السببي + استقرار التشغيل (Foundation)
**الهدف:** ضمان أن كل خطوة/قرار مسجلة ومربوطة بنتيجة، ومنع التعليق.
- إضافة Watchdog/Timeout لكل خطوة سيناريو + تسجيل سبب التوقف.
- توحيد سجل الأحداث (run_id + scenario_id + step_id).
- إضافة تحليل “مصدر التغيير”: user-run / agent-run / external.

### المرحلة 2 — القرار الحتمي + قواعد المجال + تفسير القرار
**الهدف:** قرارات منضبطة، قابلة للتفسير.
- توسيع القواعد الحتمية وربطها بنتائج القياس.
- ربط تفسير القرار في Dashboard بشكل عملي.

### المرحلة 3 — فهم UI أعمق + Coverage منهجي
**الهدف:** Model للتدفّق + Metrics تغطية.
- بناء UI Flow Model (states/transitions).
- إنشاء coverage.json وتوليد فجوات تلقائيًا.

### المرحلة 4 — تعلم تراكمي + تنقية معرفة
**الهدف:** تعلم قابل للاعتماد.
- إضافة ترجيح معرفي عبر الزمن.
- ربط التضارب بتجارب واقعية وليس فقط تقارير.

### المرحلة 5 — أهداف طويلة المدى حقيقية
**الهدف:** الأهداف ليست مجرد قائمة، بل سياسة جدولة ذاتية.
- جدولة أهداف بناء على الأثر ودرجة المخاطر.
- إرجاع نتائج الأهداف إلى policy update.

### المرحلة 6 — نشر آمن (Canary/Shadow)
**الهدف:** تعميم بدون مخاطر.
- Canary للسيناريوهات والسياسات.
- Shadow run قبل تفعيل تغيير حتمي.

---

## 4) خطة التنفيذ التفصيلية (بنود قابلة للتطبيق)

### 4.1 الاستقرار التشغيلي (فوري)
- [ ] إضافة Step Timeout في scenario_runner.
- [ ] تسجيل سبب كل توقف (timeout/blocked/upload_skipped).
- [ ] إضافة Guard لتكرار نفس الخطوة بدون تقدّم.

### 4.2 Coverage Metrics (تحسين ما هو موجود)
- [ ] ربط coverage الحالي بسجل الأهداف/الجدولة حتى يُعاد تشغيل الفجوات تلقائيًا.
- [ ] إضافة Scoring للأولويات (خطر + تكرار + أهمية).
- [ ] إدخال مفهوم task-level coverage (تدفّقات الأعمال الحرجة).

### 4.3 Causal Attribution
- [ ] تسجيل source لكل تغيير (agent vs external).
- [ ] مقارنة تغيرات النتائج قبل/بعد تنفيذ خطوة بعينها.

### 4.4 Knowledge Curation
- [ ] رفع وزن الثقة بناءً على تكرار النتائج.
- [ ] تضارب المعرفة يُربط بنتيجة تجارب حقيقية وليس مجرد heuristic.

### 4.5 Canary للسيناريوهات
- [ ] تشغيل سيناريوهات جديدة في shadow mode أولاً.
- [ ] مقارنة المقاييس قبل/بعد.

---

## 5) ما سأبدأ تنفيذه الآن (التنفيذ الفعلي)

**أول حزمة تنفيذية (Foundation):**
1) إضافة Timeouts واضحة لكل خطوة سيناريو مع تسجيل السبب.
2) تسجيل سبب “التوقف” في runtime_events.
3) إنشاء ملف coverage.json أولي اعتمادًا على runtime_events + routes.

> هذه الخطوات ضرورية قبل أي توسع آخر لأنها تمنع التعليق وتبني أساس القياس السببي.

---

## 6) معايير الإنهاء النهائي

- لا يوجد تعليق أو توقف صامت.
- كل قرار مرتبط بنتيجة قابلة للقياس.
- Coverage واضح والفجوات تُملأ تلقائيًا.
- Loop مغلق: اقتراح → تنفيذ → قياس → تحديث قواعد/نية.
- نشر آمن (Canary/Shadow) قبل أي تعميم.
