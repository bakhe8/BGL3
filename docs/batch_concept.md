# توثيق مفهوم الدفعات (Batches)

> **الإصدار النهائي المعتمد**
> هذه الوثيقة تمثل الصيغة النهائية لمفهوم الدفعات بعد دمج:
>
> * الواقع الفعلي للنظام (Truth Report)
> * مداخلة تحسين الـ Schema
> * القرار الإداري الصريح بالفصل بين *التشغيل* و*القرار*
>
> **أي تطوير لاحق يجب أن يلتزم بهذه الوثيقة حرفيًا.**

---

## 1) التعريف المعتمد للدفعة

### التعريف التشغيلي

**الدفعة** هي إطار تنظيمي للعمل الجماعي على مجموعة ضمانات، بغرض:

* الاستعراض الجماعي
* التنفيذ الجماعي (تمديد / إفراج / تخفيض)
* الطباعة الجماعية
* إنهاء العمل الجماعي بقرار صريح من المستخدم

> الدفعة **لا** تمثل حالة للضمان، ولا مصدر حقيقة تاريخية.

---

## 2) المبدأ الحاكم (غير قابل للنقاش)

> **نستخدم البيانات المشتقة للتشغيل والتنفيذ،**
> **ونستخدم metadata فقط لقرارات المستخدم.**

بناءً على ذلك:

* البيانات المشتقة تُستخدم فعليًا في:

  * عرض الدفعات
  * تنفيذ الأكشن الجماعي
  * الطباعة الجماعية
  * الفرز والترتيب
* لكنها **لا تُستخدم** لاتخاذ قرارات إدارية أو حاكمة تخص الدفعة.

---

## 3) الواقع الحالي للنظام (Truth Alignment)

* يوجد نظام دفعات فعلي ضمني مبني على:

  * `guarantees.import_source`
* كل استيراد Excel يولّد قيمة واحدة لـ `import_source`
* جميع الضمانات في نفس الملف تشترك في نفس القيمة

> **الدفعات موجودة فعليًا اليوم، لكنها غير مسماة وغير مُدارة إداريًا.**

---

## 4) تعريف الدفعة تقنيًا

### 4.1 معرف الدفعة (Batch Identifier)

* `import_source` هو معرف الدفعة الوحيد والمعتمد
* لا يوجد جدول ربط إضافي
* لا يتم تكرار هذا المعرف في أي كيان آخر

### تحسين معتمد لتفادي التصادم وزيادة وضوح الدفعة (Excel)

عند استيراد Excel، يُسمح بتحسين `import_source` ليشمل اسم الملف (بعد تنظيفه) لضمان التفرد حتى في حالات الاستيراد المتقاربة جدًا زمنيًا، وكذلك لتسهيل التعرف على الدفعة.

صيغة مقترحة:

* `excel_YYYYMMDD_HHMMSS_<sanitized_filename>`

> هذا التحسين يخص **المعرف فقط** ولا يغيّر أي منطق، ولا يُعتبر تسمية ودية (الاسم الودي يبقى في `batch_name`).

```sql
SELECT * FROM guarantees WHERE import_source = ?;
```

---

## 5) طبقة البيانات المعتمدة

### 5.1 ما الذي **لا** يتم إنشاؤه

* ❌ جدول `batches`
* ❌ جدول `batch_items`
* ❌ أي FK جديد
* ❌ أي تكرار لبيانات موجودة

---

### 5.2 ما الذي يتم تخزينه (قرارات المستخدم فقط)

#### جدول `batch_metadata`

```sql
CREATE TABLE batch_metadata (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    import_source TEXT NOT NULL UNIQUE,
    batch_name TEXT,
    batch_notes TEXT,
    status TEXT DEFAULT 'active'
);
```

هذا الجدول:

* اختياري
* لا يغيّر الحقيقة التاريخية
* لا يؤثر على Timeline
* يُستخدم فقط لقرارات المستخدم

---

## 6) البيانات المشتقة (للتشغيل فقط)

البيانات التالية **لا تُخزَّن**، لكنها تُستخدم فعليًا للتشغيل:

* عدد الضمانات في الدفعة
* قائمة الضمانات
* تاريخ الوصول
* المستخدم/المصدر
* نوع الدفعة (Excel / Manual)

أمثلة:

```sql
-- عدد الضمانات
SELECT COUNT(*) FROM guarantees WHERE import_source = ?;

-- تاريخ الوصول
SELECT MIN(imported_at) FROM guarantees WHERE import_source = ?;
```

> **هذه البيانات تشغيلية/عرضية فقط، ولا تُستخدم لاتخاذ قرارات إدارية.**

---

## 7) إنشاء الدفعات

### 7.1 دفعات الاستيراد من Excel

* كل استيراد Excel ⟶ **دفعة مستقلة تلقائيًا**
* يتم توليد `import_source` فريد لكل ملف
* جميع الضمانات داخل الملف تشترك في نفس الدفعة

> هذه دفعات صريحة تمثل عملًا جماعيًا واضحًا (ملف واحد = دفعة واحدة).

---

### 7.2 تجميع الاستيرادات غير الملفية (Email / Manual / Smart Paste)

الاستيرادات التي لا تأتي من ملف Excel **لا تُنشئ دفعة مستقلة لكل ضمان**، وذلك لتجنّب التضخم الإداري وكثرة الدفعات الصغيرة.

#### القاعدة التشغيلية

* يتم تجميع جميع الاستيرادات غير الملفية التي تتم في **نفس اليوم** ضمن **دفعة يومية واحدة مفتوحة**.
* تمثل هذه الدفعة ما يمكن تسميته إداريًا بـ: **"شغل اليوم"**.

#### كيفية التجميع

* عند إدخال ضمان جديد (Email / Manual / Smart Paste):

  * إذا وُجدت دفعة يومية مفتوحة لتاريخ اليوم ⟶ يُضاف الضمان إليها.
  * إذا لم توجد ⟶ يتم إنشاء دفعة جديدة لذلك اليوم.

#### خصائص الدفعة اليومية

* تبقى **مفتوحة** بطبيعتها.
* **لا تُغلق تلقائيًا** بنهاية اليوم.
* **لا تُغلق** عند إنشاء دفعة Excel جديدة.
* يتم إغلاقها فقط بقرار صريح من المستخدم.

> التاريخ هنا يُستخدم كوسيلة تنظيم فقط، وليس كقيد زمني أو منطق إغلاق.

---

## 8) إغلاق الدفعة

### القاعدة الحاكمة

> **تُغلق الدفعة بقرار صريح من المستخدم فقط.**

* لا تُغلق بنهاية اليوم
* لا تُغلق تلقائيًا بالاشتقاق
* لا تُغلق بناءً على Timeline

### أثر الإغلاق (سلوك تشغيلي واضح)

عند كون الدفعة `completed`:

* ❌ يُمنع تنفيذ **أي عمليات جماعية** (تمديد/إفراج/تخفيض)
* ✅ يُسمح بعرض الدفعة ومراجعتها
* ✅ يُسمح بالطباعة **بهدف المراجعة/إعادة الطباعة** فقط (بدون أي تغيير على البيانات)
* ✅ يُسمح دائمًا بفتح أي ضمان منفرد وتنفيذ عمل فردي

```sql
UPDATE batch_metadata SET status = 'completed'
WHERE import_source = ?;
```

---

## 9) واجهة المستخدم (مختصر)

### صفحة الدفعات

* قائمة دفعات مشتقة من `import_source`
* معلومات تشغيلية (عدد، تاريخ، نوع)
* حالة الدفعة من `batch_metadata` (إن وُجدت)

### صفحة الدفعة

* جدول الضمانات
* تحديد متعدد
* أكشن جماعي
* **معاينة قبل الطباعة (Print Preview)**:

  * إظهار عدد الجاهز للطباعة وغير الجاهز
  * عرض أسباب عدم الجاهزية لكل ضمان (مثلاً: مورد/بنك/اعتماد)
  * خيار طباعة الجاهز فقط
* زر: إغلاق الدفعة

---

## 10) التنفيذ الجماعي (قاعدة حاكمة)

* كل ضمان يُقيَّم منفردًا

* **السياسة الافتراضية المعتمدة: منع العملية بالكامل عند وجود أي تعارض/عدم جاهزية**

  * الهدف: الأمان ومنع نتائج جزئية مُربكة
  * يعرض النظام تقريرًا واضحًا بالضمانات غير الجاهزة وأسبابها

* عند نجاح التحقق: تُنفذ العملية على الجميع

---

## 11) البحث والمتابعة

* البحث برقم الضمان يشمل النظام كاملًا
* الدفعة تظهر كمعلومة سياقية فقط
* Timeline يبقى المصدر الوحيد للتاريخ

---

## 12) الخلاصة النهائية

> **الدفعة تنظّم العمل، ولا تحكمه.**
> **Timeline يوثّق الحقيقة، وmetadata توثّق قرار المستخدم.**

---

## 13) ملحق تنفيذي: ما تم تبنّيه من المداخلة الأخيرة

هذا الملحق يثبّت العناصر التي تم اعتمادها لأنها تضيف قيمة مباشرة بدون كسر القرارات المعتمدة في هذه الوثيقة.

### 13.1 عناصر معتمدة ✅

1. **تحسين `import_source` لدفعات Excel بإضافة اسم الملف** (بعد تنظيفه) لتقليل احتمال التصادم وزيادة وضوح التعرف على الدفعة.

2. **تجميع الإدخالات غير الملفية في دفعة يومية مفتوحة** (يدوي/لصق مباشر/Email) بدل إنشاء دفعة لكل ضمان مفرد.

3. **معاينة الطباعة قبل التنفيذ** (جاهز/غير جاهز + الأسباب) مع خيار طباعة الجاهز فقط.

4. **سياسة أمان للعمليات الجماعية: منع العملية بالكامل** إذا وُجدت أي حالة عدم جاهزية/تعارض ضمن الدفعة، مع تقرير أسباب المنع.

5. **توضيح أثر إغلاق الدفعة**: منع العمليات الجماعية، والسماح بالمراجعة والطباعة (إعادة طباعة) والعمل الفردي.

### 13.2 عناصر غير معتمدة ❌ (خارج النطاق/تعارض مع القرارات)

* إنشاء `batch_items` أو أي جدول عضوية/ربط للدفعة (تم حسمه: لا جداول ربط إضافية).
* استخدام `active_batch_id` في Session كسياق خفي يتحكم في الإدخال.
* تحويل الدفعة إلى "فلترة فقط" وإسقاط دورها التشغيلي كإطار عمل جماعي.

---

**تم اعتماد هذه الوثيقة كمرجع نهائي لتصميم وتنفيذ مفهوم الدفعات.**
