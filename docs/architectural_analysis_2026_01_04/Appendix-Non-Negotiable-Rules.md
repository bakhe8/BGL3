# ملحق: Non-Negotiable Rules & Conflict Resolution
## الملحق الإلزامي لوثيقة System Understanding Lock

> **الهدف**: تحويل الوصف إلى عقد غير قابل للتأويل أو الاجتهاد  
> **التاريخ**: 2026-01-04  
> **النسخة**: Appendix v1.0  
> **الحالة**: مطلوب الاعتماد

---

## 1. القواعد غير القابلة للتفاوض

### القاعدة #1: سيادة القرار البشري
**إذا اتخذ المستخدم قراراً يدوياً لمورد معين، فإن هذا القرار يجب أن يبقى ساري المفعول دائماً حتى يغيره المستخدم نفسه بقرار يدوي جديد، وأي override تلقائي من النظام يُعد خطأ.**

### القاعدة #2: ثبات رقم الضمان
**إذا تم حفظ رقم ضمان في النظام، فإن هذا الرقم يجب أن يبقى فريداً وثابتاً إلى الأبد، وأي تعديل أو تكرار أو حذف يُعد خطأ.**

### القاعدة #3: نهائية الإفراج
**إذا تم إفراج ضمان (released)، فإن هذا الضمان يجب أن يصبح غير قابل لأي تعديل أو إجراء أو طباعة جديدة دائماً، وأي محاولة لتعديله أو "إعادة فتحه" تُعد خطأ.**

### القاعدة #4: Append-Only للتاريخ
**إذا حدث أي حدث في النظام وتم تسجيله في التاريخ (Timeline)، فإن هذا السجل يجب أن يبقى موجوداً بنفس محتواه إلى الأبد، وأي حذف أو تعديل أو إعادة ترتيب للأحداث السابقة يُعد خطأ.**

### القاعدة #5: الحالة المشتقة لا المخزنة
**إذا كان للضمان مورد وبنك محددان، فإن حالته يجب أن تُحسب تلقائياً (ready) ولا تُخزن كقيمة مستقلة أبداً، وأي محاولة لتخزين الحالة أو تعديلها مباشرة تُعد خطأ.**

### القاعدة #6: صمت النظام عند الغموض
**إذا كانت ثقة النظام في المطابقة أقل من 70%، فإن النظام يجب أن يصمت تماماً ولا يعرض اقتراحات دائماً، وأي عرض لاقتراحات ضعيفة الثقة يُعد خطأ.**

### القاعدة #7: القرار التلقائي القابل للتجاوز
**إذا اتخذ النظام قراراً تلقائياً (ثقة >= 90%)، فإن المستخدم يجب أن يكون قادراً على تغييره بحرية كاملة دائماً، وأي منع أو تحذير أو إعاقة لهذا التغيير يُعد خطأ.**

### القاعدة #8: إلغاء القفل عند تعديل البيانات
**إذا تم تعديل أي من (المورد أو البنك أو المبلغ أو تاريخ الانتهاء) بعد طباعة خطاب، فإن قفل الإجراء النشط يجب أن يُلغى تلقائياً دائماً، وأي إبقاء على القفل مع بيانات متغيرة يُعد خطأ.**

### القاعدة #9: حتمية مطابقة البنك
**إذا تم إدخال اسم بنك، فإن النظام يجب أن ينتج نفس النتيجة (تطابق أو NULL) في كل مرة دائماً، وأي نتائج متباينة لنفس النص يُعد خطأ.**

### القاعدة #10: شرط الجاهزية للإجراءات
**إذا طُلب إجراء (تمديد/تخفيض/إفراج) على ضمان، فإن النظام يجب أن يتحقق من وجود مورد وبنك محددين (حالة ready) قبل التنفيذ دائماً، وأي تنفيذ بدون هذا التحقق يُعد خطأ.**

### القاعدة #11: التعلم من كل قرار
**إذا اختار المستخدم مورداً (سواء من الاقتراحات أو بإضافة جديد)، فإن النظام يجب أن يسجل هذا الاختيار في قاعدة التعلم دائماً، وأي تجاهل لقرار المستخدم يُعد خطأ.**

### القاعدة #12: Snapshot الخطاب الكامل
**إذا طُبع خطاب رسمي، فإن النظام يجب أن يحفظ نسخة HTML كاملة غير قابلة للتعديل من الخطاب في التاريخ دائماً، وأي حفظ جزئي أو قابل للتغيير يُعد خطأ.**

### القاعدة #13: منع الانتقال العكسي للحالات
**إذا وصل ضمان لحالة معينة (pending → ready → released)، فإن الانتقال يجب أن يكون للأمام فقط دائماً، وأي انتقال عكسي (ready → pending مثلاً) يُعد خطأ.**

### القاعدة #14: التسلسل الزمني للأحداث
**إذا حدث حدثان متتاليان، فإن الحدث الأحدث يجب أن يُسجل برقم تسلسلي أكبر أو timestamp أحدث دائماً، وأي عكس للترتيب الزمني يُعد خطأ.**

### القاعدة #15: عدم تجاوز الحقائق المطلقة
**إذا كان رقم الضمان أو Timeline أو حالة released موجودة، فإن أي محاولة لتعديلها أو تجاوزها يجب أن تُرفض تماماً دائماً، وأي سماح بهذا التجاوز يُعد خطأ.**

---

## 2. سيناريوهات التعارض الحرجة

### سيناريو #1: تعارض التعلم السابق مع القرار الجديد

**الوصف**: 
النظام تعلّم سابقاً أن "شركة العزيز" تطابق المورد #45 (ثقة 95%). المستخدم اليوم يختار يدوياً المورد #78 لنفس النص.

**من ينتصر؟**  
المستخدم (القرار اليدوي #78)

**لماذا؟**  
القاعدة #1 - سيادة القرار البشري

**متى؟**  
فوراً عند الحفظ

**ما الممنوع؟**
- ❌ تحذير المستخدم بأن "النظام يقترح #45"
- ❌ عرض نافذة تأكيد "هل أنت متأكد؟"
- ❌ إعادة override القرار تلقائياً لاحقاً
- ❌ تجاهل تسجيل القرار الجديد في التعلم

---

### سيناريو #2: تعارض الطباعة مع التعديل اللاحق

**الوصف**:
تم طباعة خطاب تمديد لضمان (تاريخ انتهاء جديد: 2027-12-31). بعد ساعة، المستخدم يعدل المبلغ من 100,000 إلى 80,000.

**من ينتصر؟**  
التعديل يُسمح، لكن القفل يُلغى تلقائياً

**لماذا؟**  
القاعدة #8 - إلغاء القفل عند تعديل البيانات

**متى؟**  
لحظة حفظ التعديل (قبل كتابة البيانات الجديدة)

**ما الممنوع؟**
- ❌ منع التعديل بحجة "خطاب مطبوع"
- ❌ إبقاء القفل رغم تغير البيانات
- ❌ عدم تنبيه المستخدم أن الخطاب السابق لم يعد صالح
- ❌ حذف snapshot الخطاب القديم من Timeline

---

### سيناريو #3: تعارض الجاهزية مع طلب الإجراء

**الوصف**:
ضمان له مورد محدد (ID: 12) لكن لا بنك (NULL). حالته: pending. المستخدم يضغط "تمديد".

**من ينتصر؟**  
النظام يرفض الإجراء

**لماذا؟**  
القاعدة #10 - شرط الجاهزية للإجراءات

**متى؟**  
قبل تنفيذ أي منطق الإجراء

**ما الممنوع؟**
- ❌ السماح بالتمديد "مؤقتاً" حتى يُحدد البنك
- ❌ تخمين البنك تلقائياً لإتمام الإجراء
- ❌ عرض رسالة غير واضحة ("حدث خطأ")
- ❌ تنفيذ الإجراء وحفظه في قائمة انتظار "pending"

**الصحيح**: رسالة واضحة "لا يمكن التمديد: يجب تحديد البنك أولاً"

---

### سيناريو #4: تعارض الاقتراح التلقائي مع الغموض

**الوصف**:
النظام وجد 3 موردين محتملين لنفس النص:
- "شركة النور" (ثقة: 65%)
- "مؤسسة النور التجارية" (ثقة: 62%)
- "النور للمقاولات" (ثقة: 58%)

أعلى ثقة = 65% (< 70%)

**من ينتصر؟**  
الصمت الكامل

**لماذا؟**  
القاعدة #6 - صمت النظام عند الغموض

**متى؟**  
عند تحميل الاقتراحات

**ما الممنوع؟**
- ❌ عرض الثلاثة "للمساعدة"
- ❌ عرض الأعلى ثقة (65%) فقط
- ❌ تفعيل "وضع تخمين" بثقة أقل
- ❌ إجبار المستخدم على الاختيار من القائمة

**الصحيح**: زر "إضافة مورد جديد" فقط

---

### سيناريو #5: تعارض الاستيراد الجديد مع السجل السابق

**الوصف**:
يُستورد ضمان برقم "BG-2024-001" من Excel. يوجد ضمان بنفس الرقم مستورد قبل 3 أشهر.

**من ينتصر؟**  
الاستيراد الجديد يُمنع

**لماذا؟**  
القاعدة #2 - ثبات رقم الضمان (فريد)

**متى؟**  
قبل حفظ البيانات (validation)

**ما الممنوع؟**
- ❌ استيراد duplicate وتسميته "BG-2024-001 (2)"
- ❌ استيراد وتجاهل الرقم القديم
- ❌ استيراد و overwrite البيانات القديمة
- ❌ استيراد بصمت وتسجيل "duplicate skipped" بدون معلومات

**الصحيح**: رفض واضح + تسجيل في Timeline + عرض تفاصيل السجل الموجود

---

## 3. تعريف صريح لما يُعد Bug

**السلوك يُعد Bug إذا انتهك أياً من القواعد الـ15 أعلاه، حتى لو:**

- ✅ لم ينهر النظام
- ✅ لم تظهر رسالة خطأ
- ✅ اعتقد المطور أنه "تحسين" أو "optimization"
- ✅ كان التغيير "أسرع" أو "أبسط"
- ✅ نجحت اختبارات automated (إذا لم تختبر القواعد)

**أمثلة على Bugs حتى بدون crash:**

1. **اقتراح بثقة 68%** → Bug (القاعدة #6)
2. **حفظ status مباشرة في DB** → Bug (القاعدة #5)
3. **override قرار مستخدم تلقائياً** → Bug (القاعدة #1)
4. **السماح بتمديد ضمان pending** → Bug (القاعدة #10)
5. **تعديل Timeline event** → Bug (القاعدة #4)
6. **إفراج ثم تمديد** → Bug (القاعدة #3)

**القاعدة الحاسمة**:  
أي سلوك يخالف "العقد الفكري" = Bug، بغض النظر عن التنفيذ التقني.

---

## الخلاصة

هذه القواعد **ليست اقتراحات** - هي **عقد ملزم**.

**أي PR مستقبلي** يمكن رفضه بالإشارة لرقم القاعدة المنتهكة.

**أي نقاش** حول "ماذا لو..." يُحسم بالرجوع لهذا الملحق.

**الاستثناءات**: لا يوجد.  
**التأويل**: ممنوع.  
**الاجتهاد**: مرفوض.

---

**تاريخ الاعتماد**: يُملأ بعد المراجعة  
**الحالة**: ✅ جاهز للاعتماد  
**الملحق بـ**: System Understanding Lock v1.0
