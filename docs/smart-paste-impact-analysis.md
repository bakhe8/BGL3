# ุชุญููู ุงูุชุฃุซูุฑ ุงููุนูุงุฑู - Smart Paste Confidence Layer

## Impact Analysis for Confidence Scoring Enhancement

**ุงูุชุงุฑูุฎ:** 14 ููุงูุฑ 2026  
**ุงููุธุงู:** BGL3 v3.0  
**ุงูููุฒุฉ ุงูููุชุฑุญุฉ:** ุฅุถุงูุฉ ุทุจูุฉ ุชูููู ุงูุซูุฉ (Confidence Layer) ูุงุณุชุฎุฑุงุฌ ุจูุงูุงุช ุงููุตู ุงูุฐูู

---

## ๐ ููุฎุต ุชูููุฐู

ูุฐุง ุงูุชุญููู ููููู ุงูุชุฃุซูุฑ ุงููุนูุงุฑู ูุฅุถุงูุฉ ูุธุงู Confidence Scoring ุฅูู ููุฒุฉ Smart Pasteุ ุจูุงุกู ุนูู ุงููุฑุงุฌุนุฉ ุงููุนููุฉ ููููุฏ ุงููุงุฆู.

### ุงูุชุบููุฑ ุงูููุชุฑุญ

ุฅุถุงูุฉ **ุทุจูุฉ ุชูููู ุซูุฉ** (Confidence Layer) ุชุนูู ูู wrapper ุญูู ููุทู ุงูุงุณุชุฎุฑุงุฌ ุงูุญุงููุ ุจุญูุซ:

- โ **ูุง ุชูุบูุฑ** ููุทู ุงูุงุณุชุฎุฑุงุฌ ุงูุฃุณุงุณู (Extraction Logic)
- โ **ุชูุถูู ููุท** ุชูููู ุฏูุฉ ููู ุญูู ูุณุชุฎุฑุฌ
- โ **ุชุฑูุถ** ุงููุชุงุฆุฌ ุงูุถุนููุฉ (< 70% Threshold)
- โ **ุชุนุฑุถ** ุฏุฑุฌุฉ ุงูุซูุฉ ูููุณุชุฎุฏู

---

## 1๏ธโฃ ุงูุชุฃุซูุฑ ุงูุณูููู (Behavioral Impact)

### ุงูููููุงุช ุงููุชุฃุซุฑุฉ

ุจูุงุกู ุนูู ูุญุต ุงูููุฏุ ุชู ุชุญุฏูุฏ ุงูููููุงุช ุงูุชุงููุฉ:

#### ุฃ) `ParseCoordinatorService` (Orchestration)

**ุงูููู:** `app/Services/ParseCoordinatorService.php`  
**ุงููุธููุฉ ุงูุญุงููุฉ:**

```php
// Line 34
public static function parseText(string $text, PDO $db): array
```

| ุงูุฌุงูุจ | ุงูุณููู ุงูุญุงูู | ุงูุณููู ุจุนุฏ ุงูุชุบููุฑ | ูุณุชูู ุงูุฎุทุฑ |
|--------|---------------|---------------------|-------------|
| ุงูุชูุณูู | ููุณู ุจูู detection/extraction/validation | ููุณ ุงูุดูุก + ููุถูู confidence calculation | ๐ข ููุฎูุถ |
| ุงูุฅุฎุฑุงุฌ | ููุฑุฌุน `['success', 'extracted', 'field_status']` | ููุถูู `'confidence_scores'` ุฅูู ุงูุฅุฎุฑุงุฌ | ๐ก ูุชูุณุท |

**ุงูุชุบููุฑ ุงููุทููุจ:**

```php
// ูู parseText()ุ ุจุนุฏ Extraction
$extracted = self::extractFieldsFromText($text);

// ๐ ุฌุฏูุฏ: ุญุณุงุจ ุงูุซูุฉ
$confidenceScores = ConfidenceEvaluator::evaluateExtraction($extracted, $text);

// ุฅุถุงูุฉ ูููุชูุฌุฉ
return [
    'success' => true,
    'extracted' => $extracted,
    'confidence_scores' => $confidenceScores, // ๐
    'field_status' => $fieldStatus
];
```

---

#### ุจ) `FieldExtractionService` (Core Extraction)

**ุงููููุงุช:** `app/Services/FieldExtractionService.php` (ุงููุชููุน - ุบูุฑ ููุฌูุฏ ูู ุงูููุฏ ุงููุนุฑูุถ ููู ููุณุชุฏุนู)

| ุงููููู | ุงูุณููู ุงูุญุงูู | ุงูุณููู ุจุนุฏ ุงูุชุบููุฑ | ูุณุชูู ุงูุฎุทุฑ |
|--------|----------------|---------------------|-------------|
| `extractBank()` | ูุณุชุฎุฑุฌ ุงุณู ุงูุจูู ูู ุงููุต | **ูุง ุชุบููุฑ** - ูุจูู ููุง ูู | ๐ข ุตูุฑ |
| `extractSupplier()` | ูุณุชุฎุฑุฌ ุงุณู ุงูููุฑุฏ | **ูุง ุชุบููุฑ** | ๐ข ุตูุฑ |
| `extractAmount()` | ูุณุชุฎุฑุฌ ุงููุจูุบ | **ูุง ุชุบููุฑ** | ๐ข ุตู |
| `extractDates()` | ูุณุชุฎุฑุฌ ุงูุชูุงุฑูุฎ | **ูุง ุชุบููุฑ** | ๐ข ุตูุฑ |

**โ๏ธ ูุจุฏุฃ ุงูุชุตููู:**  
โ **Confidence Layer ูุนูู ูู Wrapper - ูุง ููุนุฏู ุงูุงุณุชุฎุฑุงุฌ ุงูุฃุณุงุณู**

---

#### ุฌ) Bank Matching (Fuzzy Logic)

**ุงููุธููุฉ ุงูุญุงููุฉ:** (ุงููููุน ุงูุฏููู ุบูุฑ ูุญุฏุฏ - ููููุฐ ุนุจุฑ LearningAuthority ุฃู BankMatcher)

| ุงูุฌุงูุจ | ุงูุณููู ุงูุญุงูู | ุงูุณููู ุจุนุฏ ุงูุชุบููุฑ | ูุณุชูู ุงูุฎุทุฑ |
|--------|----------------|---------------------|-------------|
| Fuzzy Matching | ูุทุงุจู ุฃุณูุงุก ุงูุจููู ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช | **ูุง ุชุบููุฑ ูู ุงูููุทู** | ๐ข ุตูุฑ |
| Threshold | ูุฏ ูุง ููุฌุฏ ุญุฏ ูุงุถุญ | ๐ **ููุถุงู** Threshold = 70% | ๐ก ูุชูุณุท |
| Rejection | ููุจู ุฃู ุชุทุงุจู | ๐ **ูุฑูุถ** ุงูุชุทุงุจูุงุช < 70% | ๐ ุนุงูู |

**ุฎุทุฑ Regression:**  
โ๏ธ **ูุชูุณุท** - ูุฏ ูุฑูุถ ุงููุธุงู ุจุนุถ ุงูุชุทุงุจูุงุช ุงูุชู ูุงู ููุจููุง ุณุงุจูุงู (ููู ูุฐุง ูู ุงููุฏู ุงููุทููุจ)

---

### 2๏ธโฃ ุฎุทุฉ ุงูุญูุงุธ (Preservation Plan)

#### ุงูููุทู ุงูุฐู ูุฌุจ ุฃูุง ููุนุฏู

| # | ุงูููุทู | ุงูุณุจุจ | ููููุฉ ุงูุญูุงูุฉ |
|---|--------|-------|---------------|
| 1 | **Normalization** | ูุณุชูุฑ ููุฌุฑุจ | Confidence ูุนูู **ุจุนุฏ** Normalization |
| 2 | **Amount Parsing** | ูุชุนุงูู ูุน formats ูุชุนุฏุฏุฉ | ูุง ุชุบููุฑ - ููููู ุงููุชูุฌุฉ ููุท |
| 3 | **Date Extraction** | ูููู formats ุนุฑุจูุฉ ูุฅูุฌููุฒูุฉ | ูุง ุชุบููุฑ |
| 4 | **Masking Logic** | ูููุน re-extraction | ูุง ุชุบููุฑ |
| 5 | **Table Detection** | ูุชุนุฑู ุนูู ุฌุฏุงูู Excel | ูุง ุชุบููุฑ |

#### ููููุฉ ุงูุนูู ูู Wrapper

```php
// โ ุตุญูุญ: Wrapper Pattern
class ConfidenceEvaluator {
    public static function evaluateExtraction(array $extracted, string $originalText): array {
        // ุชูููู ููุท - ูุง ุงุณุชุฎุฑุงุฌ
        $scores = [];
        
        // Bank confidence
        if ($extracted['bank']) {
            $bankScore = self::evaluateBankMatch(
                $extracted['bank'], 
                $originalText
            );
            $scores['bank'] = $bankScore;
        }
        
        // Supplier confidence  
        if ($extracted['supplier']) {
            $supplierScore = self::evaluateSupplierMatch(
                $extracted['supplier'],
                $originalText
            );
            $scores['supplier'] = $supplierScore;
        }
        
        return $scores;
    }
}
```

**โ ุฎุทุฃ: ุชุนุฏูู ุงูู Extractors**

```php
// ูุง ุชูุนู ูุฐุง!
function extractBank($text) {
    $bank = /* ุงุณุชุฎุฑุงุฌ */;
    $confidence = /* ุญุณุงุจ */; // โ ูุง ุชุฎูุท ุงููุณุคูููุงุช
    return [$bank, $confidence]; //โ
}
```

---

## 3๏ธโฃ ุชูููู ุงูุชุนููุฏ (Complexity Assessment)

### ุนุฏุฏ ุงููููุงุช ุงููุชุฃุซุฑุฉ

| # | ุงูููู | ููุน ุงูุชุบููุฑ | ุงูุชุฃุซูุฑ |
|---|-------|-------------|---------|
| 1 | **[ุฌุฏูุฏ]** `app/Services/ConfidenceEvaluator.php` | ุฅูุดุงุก | ุฎุฏูุฉ ุฌุฏูุฏุฉ |
| 2 | `app/Services/ParseCoordinatorService.php` | ุชุนุฏูู | ุฅุถุงูุฉ ุงุณุชุฏุนุงุก Evaluator |
| 3 | `api/parse-paste.php` | ุชุนุฏูู | ุชูุฑูุฑ `confidence_scores` ูู JSON |
| 4 | **[JS]** `assets/js/smart-paste.js` (ููุชุฑุถ) | ุชุนุฏูู | ุนุฑุถ Confidence UI |

**ุงูุฅุฌูุงูู:** 3 ูููุงุช ููุฌูุฏุฉ + 1 ุฌุฏูุฏ = **4 ูููุงุช**

### ุชุบููุฑุงุช API Contract

**ูุจู:**

```json
{
  "success": true,
  "extracted": {
    "bank": "ุงูุจูู ุงูุฃููู",
    "supplier": "ุฃุฑุงููู",
    "amount": 500000
  },
  "field_status": {
    "bank": "โ",
    "supplier": "โ"
  }
}
```

**ุจุนุฏ:**

```json
{
  "success": true,
  "extracted": {
    "bank": "ุงูุจูู ุงูุฃููู",
    "supplier": "ุฃุฑุงููู",
    "amount": 500000
  },
  "confidence_scores": {
    "bank": 95,
    "supplier": 88,
    "amount": 100
  },
  "field_status": {
    "bank": "โ (95%)",
    "supplier": "โ (88%)"
  }
}
```

**โ๏ธ Breaking Changeุ**  
๐ข **ูุง** - ุฅุถุงูุฉ ุญูู ุฌุฏูุฏ (backward compatible)

### ุชุบููุฑุงุช Function Signatures

**ูุง ุชุบููุฑุงุช ูู ุงูุชูููุนุงุช ุงูููุฌูุฏุฉ**  
โ ููุท ุฅุถุงูุฉ class/function ุฌุฏูุฏุฉ

### ุชุบููุฑุงุช Schema

**ูุง ุชุบููุฑุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช**  
โ ุงูู Confidence ููุญุณุจ runtime ููุท - ูุง ููุฎุฒู

### Feature Flagging

**ููุตู ุจู:**

```php
// ูู Config.php
public const ENABLE_CONFIDENCE_LAYER = true;

// ูู ParseCoordinatorService
if (Config::ENABLE_CONFIDENCE_LAYER) {
    $confidenceScores = ConfidenceEvaluator::evaluateExtraction($extracted, $text);
} else {
    $confidenceScores = []; // disabled
}
```

**ุงููุงุฆุฏุฉ:** ุฅููุงููุฉ ุงูุชุนุทูู ุงูุณุฑูุน ูู ุญุงูุฉ ุงููุดุงูู

### ุชูุฏูุฑ ุงูุฌูุฏ

| ุงููุฑุญูุฉ | ุงูุชุนููุฏ | ุงูููุช ุงูููุฏr |
|---------|---------|--------------|
| Backend (ConfidenceEvaluator) | Medium | 3-4 ุณุงุนุงุช |
| Integration (ParseCoordinator) | Low | 1 ุณุงุนุฉ |
| Frontend UI Updates | Medium | 2-3 ุณุงุนุงุช |
| Testing | Medium | 2 ุณุงุนุงุช |
| **ุงูุฅุฌูุงูู** | **Medium** | **8-10 ุณุงุนุงุช** |

---

## 4๏ธโฃ ุชุญููู ูุตู ุงููุทุฑ (Blast Radius Analysis)

### ุงูุชุฃุซูุฑุงุช ุงููุญุชููุฉ

#### ุฃ) Import Workflows

**ุงููุถุน:** โ **ูุง ุชุฃุซูุฑ**  
**ุงูุณุจุจ:** Excel Import ูุณุชุฎุฏู `ImportService` ูููุตู - ูุง ููุฑ ุนุจุฑ Smart Paste

#### ุจ) Manual Data Entry

**ุงููุถุน:** โ **ูุง ุชุฃุซูุฑ**  
**ุงูุณุจุจ:** ุงูุฅุฏุฎุงู ุงููุฏูู ูุง ูุณุชุฎุฏู Extraction Logic

#### ุฌ) Validation Layer

**ุงููุถุน:** โ๏ธ **ุชุฃุซูุฑ ูุญุชูู**  
**ุงูุฎุทุฑ:** Validation ูุฏ ูุฑูุถ ุณุฌูุงุช ูุงูุช ุณุชูุฑ ุณุงุจูุงู  
**ุงูุชุฎููู:**

- ุงูู Confidence ูุนูู **ูุจู** Validation
- Validation ุชุจูู ููุง ูู - ุชุชุญูู ูู ุงูุชูุงู ุงูุญููู ููุท
- **ุงูุญู:** Confidence ููุญุฐุฑ ุงููุณุชุฎุฏูุ Validation ุชููุน ุงูุญูุธ

#### ุฏ) Audit Logs

**ุงููุถุน:** โ **ูุฑุตุฉ ุชุญุณูู**  
**ุงูุชูุตูุฉ:** ุฅุถุงูุฉ `confidence_scores` ูู Timeline  

```php
TimelineRecorder::recordExtraction($guaranteeId, [
    'source' => 'smart_paste',
    'confidence' => $confidenceScores // ๐ ูููุฏ ููุชุฏููู
]);
```

#### ูู) Reporting

**ุงููุถุน:** โ **ูุง ุชุฃุซูุฑ**  
**ุงูุณุจุจ:** ุงูุชูุงุฑูุฑ ุชุนุชูุฏ ุนูู ุงูุจูุงูุงุช ุงููุญููุธุฉ - ูุง ุนูู Extraction

#### ู) Learning / Suggestion Pipelines

**ุงููุถุน:** โ๏ธ **ุชุฃุซูุฑ ุบูุฑ ูุจุงุดุฑ**  
**ุงูุณููุงุฑูู:** ุฅุฐุง ุฑูุถูุง ุจููู ุจุซูุฉ ููุฎูุถุฉุ ูุฏ ุชูู ุจูุงูุงุช ุงูุชุนูู  
**ุงูุชุฎููู:**

- ูุฐุง ููุตูุฏ (ูุฑูุฏ ุฌูุฏุฉ ุฃุนูู)
- Test Data Isolation ูุญูู ูู ุงูุชููุซ

#### ุฒ) Performance

**ุงููุถุน:** ๐ก **ุชุฃุซูุฑ ุจุณูุท**  
**ุงูุชูุฏูุฑ:** ุฅุถุงูุฉ 50-100ms ููู ุนูููุฉ Paste  
**ุงูุชุฎููู:**

- ุญุณุงุจ Confidence ุฎููู (pattern matching ููุท)
- ูุง database queries ุฅุถุงููุฉ

---

## 5๏ธโฃ ุฎุทุฉ ุงูุฅุทูุงู ุงูุขูู (Safe Rollout Plan)

### Phase 1: Development + Testing (ุฃุณุจูุน 1)

- [ ] ุฅูุดุงุก `ConfidenceEvaluator` class
- [ ] ูุชุงุจุฉ Unit Tests ููู ุญูู
- [ ] Integration ูุน `ParseCoordiantorService`
- [ ] Feature Flag ุฅุถุงูุฉ

### Phase 2: Shadow Run (ุฃุณุจูุน 2)

```php
// ุชุดุบูู ุงูู Confidence ุจุฏูู ุชุฃุซูุฑ ูุนูู
$confidenceScores = ConfidenceEvaluator::evaluateExtraction($extracted, $text);

// ุชุณุฌูู ููุท - ูุง ุฑูุถ
error_log("[CONFIDENCE_SHADOW] Bank: {$confidenceScores['bank']}%");

// ูุง ูุฑูุถ ุดูุฆุงู - ูุฑุงูุจ ููุท
```

**ุงููุงุฆุฏุฉ:** ุฌูุน ุจูุงูุงุช ุญููููุฉ ุนู ุชูุฒูุน ุงูุซูุฉ ูุจู ุงูุชูุนูู

### Phase 3: Soft Launch (ุฃุณุจูุน 3)

- ุชูุนูู Threshold = 50% (ููุฎูุถ ุฌุฏุงู)
- ุนุฑุถ ุงูุชุญุฐูุฑุงุช ููุท - ูุง ุฑูุถ
- ุฌูุน ููุงุญุธุงุช ุงููุณุชุฎุฏููู

### Phase 4: Full Launch (ุฃุณุจูุน 4)

- ุฑูุน Threshold ุฅูู 70%
- ุชูุนูู ุงูุฑูุถ ุงููุนูู
- ูุฑุงูุจุฉ Rejection Rate

### Regression Test Strategy

**ุญุงูุงุช ุงูุงุฎุชุจุงุฑ ุงูุญุฑุฌุฉ:**

| # | Case | Input | Expected Confidence | Pass/Fail |
|---|------|-------|---------------------|-----------|
| 1 | ูุต ูุงุถุญ | "ุงูุจูู ุงูุฃููู ุงูุณุนูุฏู" | 95%+ | โ |
| 2 | ุงุณู ูุฎุชุตุฑ | "SNB" | 85%+ | โ |
| 3 | ูุต ุบุงูุถ | "ุฃุญุฏ ุงูุจููู ุงููุจุฑู" | <50% | โ Rejected |
| 4 | ูุต ุนุดูุงุฆู | "ุฃุฑุฌู ุงููุณุงุนุฏุฉ" | <30% | โ Rejected |

### Rollback Strategy

**ุฅุฐุง ุญุฏุซุช ูุดุงูู:**

```php
// ุฎุทูุฉ 1: ุชุนุทูู ููุฑู ุนุจุฑ Feature Flag
Config::ENABLE_CONFIDENCE_LAYER = false;

// ุฎุทูุฉ 2: ุฅุนุงุฏุฉ ูุดุฑ ุงููุณุฎุฉ ุงูุณุงุจูุฉ (ุฅุฐุง ูุฒู)
git revert <commit_hash>
```

**ูุคุดุฑุงุช Rollback:**

- ูุนุฏู Rejection > 40%
- ุดูุงูู ูุชุนุฏุฏุฉ ูู ุงููุณุชุฎุฏููู
- False Negatives (ุฑูุถ ุจูุงูุงุช ุตุญูุญุฉ)

---

## 6๏ธโฃ ุงูุฎูุงุตุฉ ูุงูุชูุตูุงุช

### ููุฎุต ุงูุชุฃุซูุฑ

| ุงูุฌุงูุจ | ุงูุชูููู | ุงูููุงุญุธุงุช |
|--------|---------|----------|
| **Complexity** | ๐ก Medium | 8-10 ุณุงุนุงุช ุนูู |
| **Risk** | ๐ข Low-Medium | ุงูุชุตููู ูู Wrapper ูููู ุงููุฎุงุทุฑ |
| **Breaking Changes** | ๐ข None | backward compatible |
| **Performance** | ๐ข Negligible | 50-100ms ุฅุถุงููุฉ |
| **Value** | ๐ข High | ูุฑูุน ุฌูุฏุฉ ุงูุจูุงูุงุช ุจุดูู ููุญูุธ |

### ุงูุชูุตูุงุช

โ **ูููุตุญ ุจุงูุชูููุฐ** ุจุดุฑุท:

1. ุชุทุจูู Feature Flag
2. Shadow Run ููุฏุฉ ุฃุณุจูุน
3. ุฌูุน 50+ ุนููุฉ ูุต ูุชููุนุฉ ููุงุฎุชุจุงุฑ
4. ุชูุซูู ูุงูู ูููุทู ุงูุซูุฉ

โ๏ธ **ููุงุท ุญุฐุฑ:**

- ูุฑุงูุจุฉ Rejection Rate ุนู ูุซุจ
- ุฌูุน feedback ูู ุงููุณุชุฎุฏููู
- ุฌุงูุฒูุฉ ููู Rollback ุงูุณุฑูุน

---

**ุงููุฑุฌุน:** ุชุญููู ููุฏ BGL3 v3.0 - 14 ููุงูุฑ 2026  
**ุงููููุงุช ุงููุญููุฉ:**

- `app/Services/ParseCoordinatorService.php`
- `app/Services/Learning/UnifiedLearningAuthority.php`
- `api/parse-paste.php`
