# ADR-007: Action-Driven Letter Generation

**الحالة (Status)**: Accepted  
**التاريخ**: 2026-01-02  
**السياق**: نظام إدارة الضمانات البنكية  
**النطاق**: توليد الخطابات (Letters) بعد جاهزية الضمان (READY)

---

## 1. السياق (Context)

يمر الضمان البنكي في النظام بمرحلتين منفصلتين تمامًا:

### مرحلة ما قبل الجاهزية (Needs Decision / Data Completion):
تهدف إلى استكمال بيانات الضمان واعتماداته (البنك، المورد، القيم…)، حتى يصبح الضمان READY.  
هذه المرحلة مستقرة وتعمل بشكل سليم، ولا علاقة لها بالخطابات أو الإجراءات.

### مرحلة ما بعد الجاهزية (Post-READY):
يكون الضمان مكتمل الأركان، محفوظًا في قاعدة البيانات، وصالحًا لأي إجراء.  
في هذه المرحلة:
- تنفيذ الإجراء **اختياري**
- ترك الضمان بدون إجراء **وضع صحيح ومقصود**
- عدم وجود خطاب **لا يعني نقصًا أو خطأ**

### المشكلة السابقة

ظهر في النظام سلوك موروث يتمثل في:
- عرض معاينة خطاب تلقائيًا عند فتح السجل
- وجود قيم افتراضية لنوع الخطاب
- استنتاج نية الخطاب من الحالة أو التاريخ (Timeline)

هذا السلوك لم يكن مدعومًا بمتطلبات عمل حقيقية، وأدى إلى خلط مفاهيمي بين:
- الجاهزية (READY)
- النية (Intent)
- الإجراء (Action)
- التاريخ (Timeline)

---

## 2. القرار (Decision)

تم اعتماد القرار المعماري التالي بشكل صريح ونهائي:

> **Letter is CREATED BY an Action**

### التفسير الدقيق للقرار:

لا يُنشأ أي خطاب إلا كنتيجة مباشرة لإجراء صريح ينفذه المستخدم:
- تمديد (Extend)
- تخفيض (Reduce)
- إفراج (Release)

**عدم تنفيذ إجراء بعد READY هو خيار مشروع ومقصود.**

**عدم وجود خطاب بعد READY لا يمثل حالة ناقصة ولا مرحلة انتقالية.**

### توزيع المسؤوليات (Separation of Concerns):

| المكون | الدور |
|--------|-------|
| **Action** | **Trigger** — يحدد متى ولماذا يُنشأ الخطاب |
| **Record State** | **Data Source** — يحدد محتوى الخطاب، ويُقرأ لحظة تنفيذ الإجراء فقط |
| **Timeline / History** | **Audit Only** — توثيق ما حدث، وليس مصدر بيانات للواجهة أو للمعاينة |

---

## 3. ما يترتب على القرار (Consequences)

### ✅ ما هو المسموح:

- إنشاء خطاب **فقط** بعد تنفيذ إجراء ناجح
- حفظ الخطاب **كما صدر** لحظة تنفيذ الإجراء
- ربط الخطاب بالحدث الموافق له في الـ Timeline كمرجع تاريخي

### ❌ ما هو غير المسموح:

1. **توليد أو عرض خطاب عند**:
   - READY
   - Save
   - تحميل السجل

2. **وجود Default أو Fallback لأي نوع خطاب**

3. **استنتاج نوع الخطاب من**:
   - حالة السجل
   - `active_action`
   - آخر حدث تاريخي

4. **استخدام Timeline كمصدر بيانات للمعاينة أو لمحتوى الخطاب**

---

## 4. التبرير (Rationale)

### 4.1 وضوح دورة الحياة

- الخطاب **ليس مرحلة** في دورة حياة الضمان
- الخطاب **نتيجة اختيارية** لإجراء
- READY تعني "جاهز للاستخدام"، **لا** "جاهز لإصدار خطاب"

### 4.2 الدقة التاريخية والقانونية

- يمنع إعادة توليد خطاب قديم ببيانات حالية مختلفة
- يسمح بعرض الخطاب **كما صدر** وقت الحدث، حتى لو تغيّر السجل لاحقًا
- يوفر أثرًا تاريخيًا وقانونيًا دقيقًا (Audit-safe)

### 4.3 القابلية للتوسع (Scalability)

إضافة إجراءات جديدة مستقبلًا (مثل: التحقق من الضمان) تتم بشكل خطي:
- Action جديد
- Event جديد
- Letter Template جديد

**بدون** تعديل منطق الجاهزية أو المعاينة.

### 4.4 إزالة النية الضمنية

- لا Default
- لا استنتاج
- لا خلط بين History وIntent

---

## 5. المصطلحات المعتمدة (Terminology)

| المصطلح | التعريف |
|---------|---------|
| **READY** | ضمان مكتمل البيانات وصالح لأي إجراء |
| **Action** | إجراء اختياري ينفذه المستخدم (Extend / Reduce / Release) |
| **Letter** | وثيقة تُنشأ نتيجة Action فقط |
| **Timeline** | سجل تاريخي للأحداث (Audit)، وليس مصدر بيانات للواجهة |
| **No Action Taken** | توصيف صحيح لوضع ضمان READY بدون خطاب.<br/>ليس حالة ناقصة، وليس مرحلة. |

> ⚠️ **يُمنع** استخدام مصطلح `empty state` في هذا السياق لأنه يوحي بمرحلة ناقصة غير موجودة.

---

## 6. البدائل التي تم رفضها (Rejected Alternatives)

| البديل | السبب |
|--------|-------|
| **Record-Driven Letters**<br/>(ربط الخطاب بحالة السجل) | ❌ مرفوض: يؤدي إلى نية ضمنية واستنتاجات خاطئة |
| **Timeline-Driven Preview**<br/>(بناء المعاينة من التاريخ) | ❌ مرفوض: خلط بين Audit وIntent، وخطر قانوني |
| **Default Letter on READY** | ❌ مرفوض: لا Requirement حقيقي يدعمه |

---

## 7. الحالة النهائية

هذا القرار:
- ✅ لا يتعارض مع أي متطلبات عمل حقيقية
- ✅ لا يكسر أي Workflow فعلي
- ✅ يبسّط المعمارية ويمنع التراكم المستقبلي للأخطاء

**القرار مُعتمد ويُعد مرجعًا معماريًا ملزمًا.**

---

## مراجع ذات صلة

- [Conflict Review Report](file:///C:/Users/Bakheet/.gemini/antigravity/brain/6daffa28-465a-4253-8b70-dc4bcf406bfd/conflict_review.md)
- [Deep Analysis Report](file:///C:/Users/Bakheet/.gemini/antigravity/brain/6daffa28-465a-4253-8b70-dc4bcf406bfd/deep_analysis.md)
