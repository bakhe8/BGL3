# ADR โ Architectural Decision Record

**ุงููุธุงู**: BGL3 โ Bank Guarantee Lifecycle  
**ุงูุชุงุฑูุฎ**: 2026-01-03  
**ุงูุญุงูุฉ**: โ ูุนุชูุฏ  
**ุงููุทุงู**: ูุฑุงุฑุงุช ูุนูุงุฑูุฉ ููุฒูุฉ ูุจู ุฃู ุชุทููุฑ ุนููู

---

## 1๏ธโฃ ูุทุงู ุงูุงุณุชุฎุฏุงู (Usage Scope)

### ุงููุฑุงุฑ:
ุงููุธุงู ููุนุชูุฏ ุญุงูููุง **ููุงุณุชุฎุฏุงู ูู ูุณุชุฎุฏู ูุงุญุฏ ููุท** (Single User / Sequential Work).

### ุงูุฃุซุฑ:
- โ ูุง ุฏุนู ููุชุฒุงูู (Concurrency)
- โ ูุง ูุนุงูุฌุฉ ูุชุนุงุฑุถ ุงูุชุนุฏููุงุช (Conflict Resolution)
- โ ุฃู ุชุทููุฑ **ูุง ููุชุฑุถ** ุชุนุฏุฏ ูุณุชุฎุฏููู

### ุงูุงูุชุฒุงู:
- ุฃู ููุฏ ุฌุฏูุฏ **ูุฌุจ** ุฃู ูููู ุขูููุง ููุงุณุชุฎุฏุงู ุงููุฑุฏู ููุท
- ูุง ุชุตููู ูุนูุฏ ูุญู ูุดุงูู ุงูุชุฒุงูู ุบูุฑ ููุฌูุฏุฉ

---

## 2๏ธโฃ ูุธุงู ุงูุชุนููู (Learning System)

### ุงููุฑุงุฑ:
ููุฌุฏ **ูุธุงูุงู ููุชุนููู ุญุงูููุง**ุ ูุณูุชู ุฏูุฌููุง ูุนูุง ุจุนุฏ ุงูุชูุงุก ูุฑุญูุฉ ุงูุชุฏููู ุงูุญุงููุฉ.

**ุงูุฃูุธูุฉ ุงูุญุงููุฉ**:
1. `LearningRepository` โ ุฌุฏูู `learning_confirmations`
2. `SupplierLearningRepository` โ ุฌุฏูู `supplier_decisions_log`

### ุงูุชุซุจูุช ุงููุฑุญูู:
- โ **ูุง ุญุฐู** ูุฃู ูุธุงู ุงูุขู
- โ **ูุง ุชูุณูุน** ุฃู ุชุนุฏูู ููุทู ุงูุชุนููู
- โ ุงูุชุทููุฑ **ูุณููุญ** ุจุดุฑุท ุนุฏู ุชุนููู ุงูุงุฒุฏูุงุฌูุฉ

### ุงููุฏู ุงููุงุฏู:
ูุตุฏุฑ ุชุนููู ูุงุญุฏ ููุญูุฏ ูุณุชููุฏ ูู ููุฉ ุงููุธุงููู

### ุงูุงูุชุฒุงู:
- ุฃู ุฅุถุงูุฉ ุฌุฏูุฏุฉ ููุชุนูู ุชููุซูู ูู **Transitional Code**
- ูุง ุชูุจูู ููุฒุงุช ุญุฑุฌุฉ ุชุนุชูุฏ ุนูู ูุธุงู ูุงุญุฏ ููุท

---

## 3๏ธโฃ ูุตุฏุฑ ุงูุญูููุฉ ููุญุงูุฉ (State Authority)

### ุงููุฑุงุฑ:
ูุตุฏุฑ ุงูุญูููุฉ ููุญุงูุฉ **ูุนุชูุฏ ุนูู ุงููุฑุญูุฉ** ูููุณ ุนูู ุญูู ูุงุญุฏ ุซุงุจุช.

### ุงูุชุนุฑูู:

#### ูุจู ุงูุฌุงูุฒูุฉ (Before Ready):
- ุงูุญุงูุฉ ุชูููู ูู ุงูุจูุงูุงุช (supplier_id / bank_id)
- `status = 'pending'` โ ุชุญุชุงุฌ ูุฑุงุฑ

#### ุจุนุฏ ุงูุฌุงูุฒูุฉ (After Ready):
- ุงูุญุงูุฉ ุชูููู ูู ุงูุฅุฌุฑุงุก (extension / reduction / release)
- `active_action` โ ูุคุดุฑ ุงูุณูุงู ูููุงุฌูุฉ

#### ุนูุฏ ุงูุฅูุฑุงุฌ (Released):
- `is_locked = 1` โ ููุงุฆูุ ุบูุฑ ูุงุจู ููุชุนุฏูู

### ุชูุณูุฑ ุงูุญููู:

| ุญูู | ุฏูุฑ | ูุชู ููุณุชุฎุฏู |
|-----|-----|-------------|
| `status` | ูุตูู (pending/ready/released) | ุนุฑุถ ุนุงู |
| `active_action` | ุณูุงูู ูููุงุฌูุฉ (extension/reduction/release/null) | ูุนุงููุฉ ุงูุฎุทุงุจ |
| `is_locked` | ููุงุฆู (0/1) | ููุน ุงูุชุนุฏูู ุจุนุฏ ุงูุฅูุฑุงุฌ |

### ุงูุงูุชุฒุงู:
- ูุง ุชุถุงู ุญููู ุญุงูุฉ **ุฌุฏูุฏุฉ** ุจุฏูู ุฏูุฌ ูุน ุงูุญุงููุฉ
- ุฃู ููุทู ูุนุชูุฏ ุนูู ุงูุญุงูุฉ ูุฌุจ ุฃู **ููุซูู ุฃู ุญูู ููุฑุฃ**

---

## 4๏ธโฃ ูุทุงุจูุฉ ุงูุจูู (Bank Matching)

### ุงููุฑุงุฑ:
ูุทุงุจูุฉ ุงูุจูู ุจุนุฏ **Auto-Match ููุงุฆูุฉ** ูุบูุฑ ูุงุจูุฉ ููุชุนุฏูู ุงููุฏูู.

### ุงูุชุฏูู:
```
Import โ SmartProcessing โ Bank Matched โ raw_data['bank'] updated โ FINAL
```

### ุงูุฃุซุฑ:
- โ ุงูุจูู ููุญุฏุฏ **ูุฑุฉ ูุงุญุฏุฉ** ุชููุงุฆููุง
- โ ุฃู ููุฏ ููุชุฑุถ ุชุบููุฑ ุงูุจูู ูุงุญููุง ููุนุชุจุฑ **legacy**
- โ ูุง ููุทู ุฌุฏูุฏ ูุณูุญ ุจุชุบููุฑ ุงูุจูู ูุฏูููุง

### ุงูููุงุฆุฏ:
- ููู ุงูุชุนููุฏ
- ูููู ุงูุณุฌู ุงูุชุงุฑูุฎู
- ูุง ุชุนุงุฑุถุงุช ูู ุจูุงูุงุช ุงูุจูู

### ุงูุงูุชุฒุงู:
- ุฃู API/endpoint ูุญุงูู ุชุนุฏูู `bank_id` ุจุนุฏ ุงูุชุทุงุจู โ **ูุฑููุถ**
- `save-and-next.php` **ูุง ูุฑุณู** ููุง **ูุณุชูุจู** ุจูุงูุงุช ุงูุจูู

---

## 5๏ธโฃ ุงูุชุทููุฑ ุจุงูุชูุงุฒู (Parallel Development)

### ุงููุฑุงุฑ:
**ูุณููุญ** ุงูุงุณุชูุฑุงุฑ ุจุงูุชุทููุฑ ุจุงูุชูุงุฒู ุจุดุฑูุท ุตุงุฑูุฉ.

### ุงููููุฏ ุงูุฅูุฒุงููุฉ:

#### โ ููููุนุงุช:
1. **ูุง ุฅุถุงูุฉ ุญุงูุงุช ุฌุฏูุฏุฉ** (status values)
2. **ูุง ุชุนุฏูู ููุทู ุงูุชุนููู** (ุฅูุง ููุฏูุฌ ุงููุฎุทุท)
3. **ูุง ุงุนุชูุงุฏ ุฌุฏูุฏ** ุนูู ุญููู ุญุงูุฉ ุฅุถุงููุฉ
4. **ูุง ุงูุชุฑุงุถ ูุชุนุฏุฏ ูุณุชุฎุฏููู** (concurrency)
5. **ูุง ุชุบููุฑ ูู ููุทู Timeline** (ุฅูุง ููุฅุตูุงุญ)

#### โ ูุณููุญุงุช:
1. ุฅุถุงูุฉ **endpoints** ุฌุฏูุฏุฉ (ุฅุฐุง ูู ุชุฎุงูู ุงููููุฏ)
2. ุชุญุณูู **ุงูุฃุฏุงุก** (ุจุฏูู ุชุบููุฑ ุงูุณููู)
3. ุฅุตูุงุญ **ุงูุฃุฎุทุงุก** (bugs)
4. ุฅุถุงูุฉ **ุชุญูู ูู ุงูุจูุงูุงุช** (validation)
5. ุชุญุณูู **ูุงุฌูุฉ ุงููุณุชุฎุฏู** (UI/UX)

### ุงููุจุฏุฃ:
**ุฃู ููุฏ ุฌุฏูุฏ ููุนุชุจุฑ Transitional Code**  
ููุงุจู ูุฅุนุงุฏุฉ ุงูุฏูุฌ ุฃู ุงูุฅุฒุงูุฉ ูุงุญููุง ุนูุฏ ุฅุนุงุฏุฉ ุงูููููุฉ

---

## 6๏ธโฃ ูููุฏ ููุฑูุฉ ุนูู ุงูููุฏ

### ูุฑุงุฑ ููุฒู:

#### โ ููููุน:
1. **ุฅุถุงูุฉ ุฃู ููุทู ุฌุฏูุฏ ุฏุงุฎู `index.php`**
   - ุงูููู ุจูุบ 2,551 ุณุทุฑ (ุงูุญุฏ ุงูุฃูุตู)
   - ุฃู ุฅุถุงูุฉ ุชุฒูุฏ ุงูุชุนููุฏ ุจุดูู ุฎุทูุฑ

2. **ุชูุณูุน ุญุฌู ุงูููู ุฃู ุชุนููุฏู**
   - ูุง inline JavaScript ุฌุฏูุฏ
   - ูุง inline CSS ุฌุฏูุฏ
   - ูุง ุงุณุชุนูุงูุงุช ุฌุฏูุฏุฉ ูุจุงุดุฑุฉ

#### โ ุจุฏูู:
- ุฅูุดุงุก **Services** ุฌุฏูุฏุฉ (ูู `app/Services/`)
- ุฅูุดุงุก **Partials** ุฌุฏูุฏุฉ (ูู `partials/`)
- ุงุณุชุฎุฏุงู **API endpoints** (ูู `api/`)

### ุงููุฏู:
ุชุฌููุฏ `index.php` ุงุณุชุนุฏุงุฏูุง ูุฅุนุงุฏุฉ ุงูููููุฉ ุงููุงููุฉ

---

## 7๏ธโฃ Timeline Integrity (ุณูุงูุฉ ุงูุณุฌู)

### ุงููุฑุงุฑ:
ููุท **Snapshot โ Update โ Record** **ุฅูุฒุงูู** ูุฃู ุชุนุฏูู ุนูู ุงูุจูุงูุงุช.

### ุงูุชุฏูู ุงููุทููุจ:
```php
// 1. SNAPSHOT
$oldSnapshot = TimelineRecorder::createSnapshot($guaranteeId);

// 2. UPDATE
// ... ุชุนุฏูู ุงูุจูุงูุงุช ...

// 3. RECORD
TimelineRecorder::recordEvent(..., $oldSnapshot, ...);
```

### ุงูุงูุชุฒุงู:
- โ **ูุง ุชุนุฏูู** ูุจูุงูุงุช ุงูุถูุงู ุจุฏูู ุชุณุฌูู
- โ **ูุง ุชุญุฏูุซ** `raw_data` ุฅูุง ุนุจุฑ `GuaranteeRepository::updateRawData()`
- โ **ูู** ุชุบููุฑ ูุฌุจ ุฃู ูุธูุฑ ูู Timeline

---

## 8๏ธโฃ Database Schema Freeze

### ุงููุฑุงุฑ:
**ุชุฌููุฏ** ุฃู ุชุนุฏููุงุช ุนูู ุฌุฏุงูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุญุชู ุฅุดุนุงุฑ ุขุฎุฑ.

### ุงููุณููุญ:
- โ ุฅุถุงูุฉ **Indexes** ููุฃุฏุงุก
- โ ุฅุถุงูุฉ **Migration scripts** ููุจูุงูุงุช

### ุงูููููุน:
- โ ุฅุถุงูุฉ **ุฌุฏุงูู ุฌุฏูุฏุฉ**
- โ ุฅุถุงูุฉ **ุฃุนูุฏุฉ ุฌุฏูุฏุฉ**
- โ ุชุบููุฑ **ุฃููุงุน ุงูุจูุงูุงุช**
- โ ุญุฐู ุฃู ุดูุก

### ุงูุงุณุชุซูุงุก:
ุงูุชุนุฏููุงุช ุงููุฎุทุทุฉ ูุฏูุฌ ุฃูุธูุฉ ุงูุชุนูู (ุจุนุฏ ุงูููุงููุฉ)

---

## 9๏ธโฃ Error Handling Principle

### ุงููุฑุงุฑ:
**ุงููุดู ุงููุฑุฆู ุฃูุถู ูู ุงููุดู ุงูุตุงูุช** (Fail Visible, Not Silent)

### ุงููุจุฏุฃ:
```php
// โ ุณูุฆ - ูุฎูู ุงูุฎุทุฃ
try {
    criticalOperation();
} catch (Exception $e) {
    error_log($e->getMessage()); // ุตุงูุช!
}

// โ ุฌูุฏ - ููุธูุฑ ุงูุฎุทุฃ
try {
    criticalOperation();
} catch (Exception $e) {
    error_log($e->getMessage());
    throw $e; // ุฃู ุนุฑุถ ุฑุณุงูุฉ ูุงุถุญุฉ ูููุณุชุฎุฏู
}
```

### ุงูุงูุชุฒุงู:
- ุฃู ุนูููุฉ **ุญุฑุฌุฉ** ูุฌุจ ุฃู ุชูุดู ุจูุถูุญ
- `try-catch` ููุท ููุนูููุงุช **ุบูุฑ ุงูุญุฑุฌุฉ** (notes, attachments)
- ุฃุฎุทุงุก ุงูุชุญูู **ูุฌุจ** ุฃู ุชุนูุฏ ูููุณุชุฎุฏู ุจูุถูุญ

---

## ๐ Enforcement (ุงูุฅูุฒุงู)

### ูุฑุงุฌุนุฉ ุงูููุฏ:
ุฃู Pull Request ูุฎุงูู ูุฐู ุงููุฑุงุฑุงุช โ **ูุฑููุถ**

### ุงูุงุณุชุซูุงุกุงุช:
ุชุญุชุงุฌ ููุงููุฉ ุตุฑูุญุฉ ูุน **ุชูุซูู ุงูุณุจุจ**

### ุงููุฑุงุฌุนุฉ ุงูุฏูุฑูุฉ:
ูู ุดูุฑ (ุฃู ุนูุฏ ููุทุฉ ุชุญูู ุฑุฆูุณูุฉ)

---

## ๐ Checklist ููุชุทููุฑ ุงูุฌุฏูุฏ

ูุจู ุฅุถุงูุฉ ุฃู ููุฏ ุฌุฏูุฏุ ุชุฃูุฏ:

- [ ] โ ูุง ููุชุฑุถ ุชุนุฏุฏ ูุณุชุฎุฏููู
- [ ] โ ูุง ูุถูู ุญููู ุญุงูุฉ ุฌุฏูุฏุฉ
- [ ] โ ูุง ูุนุฏู ููุทู ุงูุชุนูู
- [ ] โ ูุง ูุถูู ููุฏ ูู `index.php`
- [ ] โ ูุชุจุน ููุท Snapshot โ Update โ Record
- [ ] โ ุงูุฃุฎุทุงุก ุงูุญุฑุฌุฉ ูุฑุฆูุฉ (ูุง ุตุงูุชุฉ)
- [ ] โ ูุง ุชุนุฏูู ุนูู schema ูุงุนุฏุฉ ุงูุจูุงูุงุช
- [ ] โ ุงูุจูู ูุง ูุชุบูุฑ ุจุนุฏ Auto-Match

---

## ๐ ุงููุฑุงุฌุน

- **File-Level Audit**: `1_file_level_audit.md`
- **Logic Flow Map**: `2_logic_flow_map.md`
- **Duplication Report**: `3_duplication_contradiction.md`
- **Risk Assessment**: `4_risk_assessment.md`
- **System Readiness**: `5_system_readiness_verdict.md`

---

**ุชุงุฑูุฎ ุงูุงุนุชูุงุฏ**: 2026-01-03  
**ุงููุฑุงุฌุนุฉ ุงููุงุฏูุฉ**: 2026-02-03  
**ุงูุญุงูุฉ**: ูุดุท โ

*ูุฐู ุงููุฑุงุฑุงุช ููุฒูุฉ ูุฌููุน ุงูุชุทููุฑุงุช ุงููุณุชูุจููุฉ ุญุชู ุงููุฑุงุฌุนุฉ ุงูุฑุณููุฉ.*
