# خارطة الطريق: أفضل 10 إصلاحات للوكيل (مرجع عمل)

## الهدف العام
إغلاق الحلقة المعرفية للوكيل عبر ربط الاستكشاف بالقرار والتعلم التراكمي، مع توحيد السلطة والإعدادات والمخططات، لضمان نمو ذاتي مستقر وتقليل التوقفات.

## الحالة الحالية (مختصر)
تم تنفيذ أساسيات مهمة بالفعل: فصل نتائج الاستكشاف عن نتائج القرارات، إضافة طبقة Hypothesis أولية، وتمرير Purpose (volition) للتقارير، وتحسين intent_resolver وربط reasoning hints. ما ينقص هو تحويل هذه الطبقات إلى مسار واحد يعمل كتغذية راجعة مستمرة.

## المبادئ التشغيلية
1. كل طبقة يجب أن تنتج أثراً قابلاً للقياس في القرار أو الاستكشاف.
2. لا تُضاف طبقة جديدة دون مسار قراءة/كتابة واضح في `knowledge.db`.
3. أي مخرجات سياقية (auto_insights) يجب أن تكون حديثة أو يتم تجاهلها تلقائياً.
4. الإعدادات الفعالة يجب أن تكون مرئية ومحددة المصدر (config vs flags).

---

## خارطة الطريق التفصيلية (10 نقاط)

### 1) ربط Hypothesis بقرار النية مباشرة
**الهدف:** تحويل الفرضيات إلى عامل مؤثر في `intent_resolver` و`decision_engine`.  
**الحالة الحالية:** لدينا Hypothesis ولكنها لا تُؤثر على القرار إلا بشكل غير مباشر.  
**ما سأقوم به:**
1. إدخال `hypotheses` ضمن السياق الذي يُغذّي `intent_resolver`.
2. إضافة منطق بسيط لترجيح intent بناءً على hypothesis tags (stabilize/unblock/evolve).
3. تسجيل قرار التحويل في سجل outcomes لقياس الأثر.
**مخرجات قابلة للقياس:** `intent` يتغير عند وجود فرضيات حرجة، مع تفسير واضح في `reason`.  
**الاعتمادات:** قاعدة بيانات `knowledge.db` وجداول hypotheses.

### 2) دورة حياة كاملة للفرضيات
**الهدف:** جعل الفرضيات كياناً يُولد، يُختبر، ثم يُغلق.  
**الحالة الحالية:** status موجود لكن لا يوجد مسار إغلاق مؤكد.  
**ما سأقوم به:**
1. تعريف حالات: `open`, `confirmed`, `contradicted`, `archived`.
2. قواعد انتقال مرتبطة بنتائج الاستكشاف (`exploration_outcomes`).
3. وظائف تقييم تلقائية (مثال: 3 دعم متتالٍ = confirmed).
**مخرجات قابلة للقياس:** جدول hypotheses يظهر نسب confirmed/contradicted.  
**الاعتمادات:** دمج outcomes الاستكشاف بشكل منتظم.

### 3) Learning Core موحّد
**الهدف:** تحويل التعلم إلى مصدر تراكمي واحد يغذي القرار والاستكشاف.  
**الحالة الحالية:** `learning_confirmations` و`learned_events.tsv` منفصلين.  
**ما سأقوم به:**
1. إنشاء جدول موحد `learning_events` في `knowledge.db`.
2. ربط الأحداث من `learned_events.tsv` عند التوفر.
3. تحديث `outcome_signals` لاستيعاب التعلم الموحد.
**مخرجات قابلة للقياس:** إشارات تعلمية واضحة في التقارير.  
**الاعتمادات:** موافقة على إضافة جدول جديد.

### 4) Purpose موجّه للقرار والاستكشاف
**الهدف:** تحويل `purpose/volition` من وصف إلى قوة توجيه.  
**الحالة الحالية:** purpose يظهر في التقرير فقط.  
**ما سأقوم به:**
1. إدخال purpose ضمن سياق intent_resolver.
2. ربط purpose بأولوية اختيار السيناريوهات.
3. تسجيل أثر purpose في intent السبب.
**مخرجات قابلة للقياس:** تغير واضح في ترتيب الأهداف/السيناريوهات بناءً على purpose.

### 5) دمج القرار والاستكشاف في مسار واحد
**الهدف:** إنهاء الفصل بين "قرار" و"استكشاف" في دورة واحدة مغلقة.  
**الحالة الحالية:** الطبقتان منفصلتان مع إشارات جزئية.  
**ما سأقوم به:**
1. مسار موحّد: outcomes → hypotheses → intent → decision → scenario goals.
2. تغذية القرار التالي بنتائج الاستكشاف السابقة مباشرة.
3. منع تكرار الأهداف إذا لم تُنتج نتائج جديدة.
**مخرجات قابلة للقياس:** انخفاض حالات STALLED وارتفاع نتائج ذات أثر.

### 6) علاج توقف الاستكشاف (STALLED)
**الهدف:** رفع إنتاج نتائج قابلة للقياس وتقليل الاستكشاف الفارغ.  
**الحالة الحالية:** معدلات فشل عالية وأهداف مكررة.  
**ما سأقوم به:**
1. اعتماد حد أدنى لقيمة الأثر قبل تسجيل النتيجة.
2. إعادة توزيع الأهداف بناءً على gaps الأعلى.
3. تعديل آلية novelty probe لتفادي التكرار.
**مخرجات قابلة للقياس:** انخفاض failure_rate، وارتفاع `gap_deepen` المفيد.

### 7) توحيد السلطة والموافقات (Authority)
**الهدف:** إنهاء أي ازدواجية أو تعارض توثيقي.  
**الحالة الحالية:** التنفيذ موحد فعلياً، لكن التوثيق والمسارات القديمة غير نظيفة.  
**ما سأقوم به:**
1. تنظيف أي دوال قديمة غير مستخدمة.
2. تحديث `AUTHORITY_INVENTORY.md` ليعكس الواقع.
3. إضافة Check يتحقق من عدم الانحراف.
**مخرجات قابلة للقياس:** مسار واحد فعلي ومُوثق فقط.

### 8) توحيد مصدر الإعدادات الفعلية
**الهدف:** معرفة الإعدادات الفعلية دائمًا بدون التباس.  
**الحالة الحالية:** تداخل بين `config.yml` و`storage/agent_flags.json`.  
**ما سأقوم به:**
1. طبقة قراءة موحدة توضّح المصدر الفعّال لكل إعداد.
2. إظهار الإعدادات الفعالة في التقرير والـDashboard.
3. توثيق ترتيب الأولوية بشكل صريح.
**مخرجات قابلة للقياس:** صفحة تعرض “Effective Config” بوضوح.

### 9) مخطط قاعدة بيانات رسمي للجداول الجديدة
**الهدف:** ضمان ثبات الجداول الجديدة عبر كل البيئات.  
**الحالة الحالية:** بعض الجداول تُنشأ ديناميكيًا فقط.  
**ما سأقوم به:**
1. إضافة مخطط رسمي (migration أو SQL) لجداول exploration/hypotheses/learning.
2. تحديث `db_schema.json` و`docs/db_schema.md`.
3. فحص توافق عند التشغيل.
**مخرجات قابلة للقياس:** بيئة جديدة تعمل بدون جداول ناقصة.

### 10) إدارة auto_insights لتفادي السياق القديم
**الهدف:** منع سياق قديم من تضليل القرار.  
**الحالة الحالية:** يتم تحميل auto_insights مع hash check جزئي.  
**ما سأقوم به:**
1. توسيع فحص الـhash ليشمل كل insight مرتبط بالكود.
2. إعادة توليد أو تجاهل أي insight قديم.
3. إضافة تقرير بسيط لعدد insights النشطة/المعطلة.
**مخرجات قابلة للقياس:** انخفاض الأخطاء الناتجة عن سياق قديم.

---

## مقياس النجاح النهائي
1. Intent يتغير بناءً على hypotheses والتعلم.  
2. الاستكشاف ينتج نتائج مؤثرة، وليس مجرد أحداث.  
3. القرارات تُترجم إلى أهداف وسيناريوهات بوضوح.  
4. إعدادات التشغيل معلنة بدقة.  
5. المخطط ثابت والبيئات الجديدة تعمل بدون فجوات.

---

## ما سنفعله تاليًا
ابدأ من النقطة (1) ثم (2) ثم (3). هذه الثلاثة هي القلب الحقيقي للنظام، وما بعدها يُحسّن الثبات والوضوح.
