# العقد الفكري لنظام BGL
## System Understanding Lock — Phase 0.9

> **الهدف**: تثبيت الفهم التشغيلي للنظام كنظام حي قبل أي تعديل  
> **التاريخ**: 2026-01-04  
> **الحالة**: Pre-Refactor Understanding Lock  
> **القيود**: لا حلول، لا كود، لا مسارات، لا توصيات تنفيذية

---

## 1. ما هو النظام؟

### المشكلة التي يحلها

**الموقف**: 
تصل بيانات ضمانات بنكية من مصادر متعددة (Excel، نصوص ملصوقة، إدخال يدوي) بأشكال **غير منظمة** وبها **أخطاء إملائية** و**اختصارات** و**تنسيقات مختلفة**.

**المشكلة الحقيقية**:
- موظف يحتاج معالجة **مئات الضمانات** يومياً
- كل ضمان يحتاج ربط بـ **مورد** و **بنك** من قاعدة بيانات
- المطابقة يدوية = **بطيئة جداً** و**عرضة للخطأ**
- إصدار خطابات رسمية يحتاج **دقة 100%**

**الحل الذي يقدمه النظام**:
```
نظام هجين = ذكاء اصطناعي محلي + قرار بشري نهائي

1. يستقبل بيانات فوضوية
2. يطبّعها (normalization)
3. يقترح مطابقات محتملة (بناءً على التعلم)
4. ينتظر المستخدم ليقرر
5. يتعلم من قراره
6. يوثق كل شيء (timeline)
7. يصدر خطابات رسمية
```

**ليس نظام CRUD - هو State Machine + Decision Support**

---

### ما هو "القرار" في النظام؟

**القرار** = اختيار نهائي للمورد والبنك لضمان معين

**خصائص القرار**:
- **ملزم**: بمجرد اتخاذه، يُبنى عليه كل شيء لاحقاً
- **موثق**: يُسجل في Timeline مع التاريخ والوقت
- **قابل للتعديل**: المستخدم يمكنه تغييره (مع تسجيل التغيير)
- **له أثر**: تغيير القرار يلغي أي خطابات مطبوعة سابقاً

**أنواع القرارات**:
1. **قرار يدوي**: المستخدم اختار بنفسه
2. **قرار تلقائي**: النظام اتخذه (ثقة عالية >= 90%)
3. **قرار مؤكد**: المستخدم وافق على قرار تلقائي

---

### ما هو "الاقتراح"؟

**الاقتراح** = خيار محتمل يعرضه النظام، **ليس قراراً**

**الفرق الحاسم**:
- الاقتراح **لا يُكتب** في قاعدة البيانات
- الاقتراح **يُنسى** بمجرد إغلاق الصفحة
- القرار **يبقى** ويُبنى عليه

**مصادر الاقتراحات** (بالترتيب):
1. **مطابقة دقيقة**: الاسم المطبّع موجود تماماً
2. **كيانات مشتركة**: الاسم يحتوي على جزء من اسم معروف
3. **تاريخي**: تم استخدامه مع هذا الاسم من قبل
4. **تقارب نصي**: التشابه بين النصوص >= 70%
5. **تعلم سابق**: المستخدم اختاره لاسم مشابه

---

### متى يكون النظام مساعداً؟

**النظام يتدخل تلقائياً عندما**:
1. **الثقة عالية جداً** (>= 90%)
2. **المطابقة حتمية** (اسم البنك مثلاً)
3. **لا غموض** (خيار واحد واضح)

**النظام يقترح (لا يقرر) عندما**:
1. الثقة متوسطة (70-89%)
2. عدة خيارات محتملة
3. السياق غير واضح

**مثال**:
```
الاسم الخام: "شركة العزيز للتجارة"

IF النظام وجد:
  - مطابقة دقيقة: "شركة العزيز للتجارة" (ID: 45)
  - استخدام سابق: 20 مرة
  - ثقة: 95%

THEN:
  → قرار تلقائي (supplier_id = 45)

ELSE IF النظام وجد:
  - "شركة العزيز" (60% تطابق)
  - "العزيز للتجارة العامة" (55% تطابق)
  - ثقة أعلى: 85%

THEN:
  → اقتراحات فقط (المستخدم يقرر)
```

---

### متى يجب أن يصمت النظام تماماً؟

**النظام يصمت في**:

1. **عدم وجود مطابقة معقولة** (ثقة < 70%)
   - يعرض زر "إضافة مورد جديد" فقط
   - لا اقتراحات = لا ضجيج

2. **المستخدم غيّر يدوياً مرة واحدة**
   - تفضيله أهم من أي اقتراح
   - لا override للقرار البشري

3. **الضمان في حالة نهائية** (تم الإفراج)
   - لا تعديل = لا اقتراحات
   - النظام "مغلق"

4. **البيانات الحرجة** (المبلغ، تاريخ الانتهاء)
   - فقط عبر إجراءات رسمية (تمديد/تخفيض)
   - لا تعديل مباشر أبداً

---

### ما هو "الحقيقة" (Truth) التي لا يجوز تجاوزها؟

**حقائق مطلقة**:

1. **رقم الضمان فريد**
   - لا تكرار، لا تعديل بعد الإنشاء
   - أي تغيير = ضمان جديد

2. **Timeline لا يُمسح**
   - كل حدث يُسجل للأبد
   - تدقيق كامل، لا محو تاريخ

3. **الإفراج نهائي**
   - بمجرد الإفراج، لا رجوع
   - الضمان "ميت"، لا يُعاد إحياؤه

4. **القرار البشري يعلو**
   - النظام يقترح، الإنسان يقرر
   - لا override تلقائي لقرار يدوي

5. **الخطاب المطبوع صالح لحظة طباعته فقط**
   - أي تعديل على البيانات يلغي الخطاب
   - يجب طباعة جديد

---

## 2. الكيانات الجوهرية

### الكيانات الأساسية (Entities)

**1. الضمان (Guarantee)**
- **ما هو**: وثيقة نقدية تضمن التزام مورد
- **يُعرّف بـ**: رقم الضمان (فريد)
- **يحتوي على**: مبلغ، مورد، بنك، تاريخ انتهاء

**2. المورد (Supplier)**
- **ما هو**: طرف خارجي (شركة/فرد) له ضمان
- **التحدي**: اسم واحد، 10 أشكال مختلفة
- **الحل**: تطبيع + aliases

**3. البنك (Bank)**
- **ما هو**: جهة إصدار الضمان
- **مميز**: عدد محدود، أسماء رسمية

**4. القرار (Decision)**
- **ما هو**: ربط بين ضمان ومورد وبنك
- **ليس**: بيانات خام، هو **تفسير** للبيانات

**5. الإجراء (Action)**
- **ما هو**: تغيير رسمي (تمديد/تخفيض/إفراج)
- **يحتاج**: موافقة، توثيق، طباعة

---

### ما يمثل حالة (State)

**الحالات الأربع**:

```
1. raw_imported   = بيانات موجودة، لا قرار
2. pending        = قرار جزئي (مورد أو بنك ناقص)
3. ready          = قرار كامل (مورد + بنك)
4. released       = تم الإفراج (نهائي)
```

**الانتقالات المسموحة**:
```
raw → pending → ready → released
  ↓      ↓        ↓
 (يمكن الذهاب للأمام فقط)
```

**الانتقالات الممنوعة**:
```
❌ ready → pending   (لا يمكن "إلغاء" الجاهزية)
❌ released → ready  (لا رجوع بعد الإفراج)
```

**من يحدد الحالة؟**
- ليس المستخدم
- ليس المطور
- **الحالة = نتيجة حسابية من (مورد + بنك)**

---

### ما يمثل حدثاً (Event)

**الحدث** = شيء حصل في نقطة زمنية محددة، **لا يمكن إلغاؤه**

**أنواع الأحداث**:
1. **استيراد**: ضمان دخل النظام
2. **قرار**: مستخدم اختار مورد/بنك
3. **تمديد**: زيادة فترة الضمان سنة
4. **تخفيض**: تقليل المبلغ
5. **إفراج**: إنهاء الضمان

**خصائص الحدث**:
- **ثابت**: لا تعديل بعد التسجيل
- **موثق**: من؟ متى؟ ماذا؟
- **متسلسل**: الترتيب مهم
- **شامل**: يحفظ نسخة كاملة من البيانات لحظة الحدث

---

### ما يمثل أثراً دائماً (Permanent Effect)

**الأثر الدائم** = تغيير لا يمكن التراجع عنه

**الأمثلة**:

1. **الإفراج**:
   - الضمان "مغلق" للأبد
   - لا تمديد، لا تعديل، لا طباعة جديدة

2. **Timeline Event**:
   - مخزن في قاعدة البيانات
   - لا حذف، لا تعديل
   - دليل تدقيق دائم

3. **Learning Confirmation**:
   - النظام "تعلم" من قرار المستخدم
   - لا نسيان، يتراكم

4. **الخطاب المطبوع** (snapshot):
   - نسخة HTML محفوظة للأبد
   - حتى لو تغيرت البيانات الأصلية

---

## 3. خريطة السلطات

### من يملك حق اتخاذ القرارات؟

| القرار | من يملكه؟ | من يقترحه؟ | من يرفضه؟ | هل يُتجاوز؟ |
|--------|-----------|------------|-----------|-------------|
| **اختيار المورد** | المستخدم (نهائي) | النظام (تعلم) | المستخدم | نعم (user override) |
| **اختيار البنك** | النظام (حتمي) | - | - | لا (إضافة بنك جديد فقط) |
| **تحديد الحالة** | لا أحد (محسوبة) | - | - | مستحيل |
| **التمديد/التخفيض** | المستخدم (طلب) + النظام (تنفيذ) | - | النظام (إذا حالة خاطئة) | لا |
| **الإفراج** | المستخدم | - | - | لا (نهائي) |
| **تسجيل Timeline** | النظام (تلقائي) | - | - | مستحيل |

---

### القاعدة الذهبية للسلطة

```
النظام يقترح → المستخدم يقرر → النظام يوثق

لا عكس أبداً.
```

**الاستثناء الوحيد**: 
عندما الثقة >= 90% **و** لا غموض **و** لا قرار سابق  
→ النظام يقرر تلقائياً (لكن قابل للتعديل)

---

### متى يُتجاوز القرار؟

**يمكن تجاوز**:
- اقتراح النظام (دائماً)
- قرار تلقائي سابق (بقرار يدوي)
- مورد/بنك محدد (بتغيير المستخدم)

**لا يمكن تجاوز**:
- رقم الضمان (فريد)
- Timeline (append-only)
- حالة "released" (نهائي)
- منطق حساب الحالة (derived)

---

## 4. التسلسل الزمني للتصرفات

### الدورة الكاملة: من الإدخال إلى الخطاب

**المرحلة 1: الاستيراد (Import)**
```
00:00 - المستخدم يلصق نص أو يرفع Excel
00:01 - النظام يحلل النص (regex patterns)
00:02 - يستخرج: رقم، مورد، بنك، مبلغ، تاريخ
00:03 - يطبّع الأسماء (إزالة diact، توحيد المسافات)
00:04 - يحفظ في قاعدة البيانات (guarantees)
00:05 - يسجل حدث "استيراد" في Timeline
```

**المرحلة 2: المطابقة التلقائية (Auto-Matching)**
```
00:10 - النظام يبحث عن مطابقات محتملة
00:11 - للمورد: يستعلم Learning Authority
00:12 - يحصل على 5 إشارات (alias، anchor، historical، fuzzy، learning)
00:13 - يحسب confidence score
00:14 - للبنك: يستخدم خوارزمية حتمية
00:15 - إذا confidence >= 90%: يحفظ قرار تلقائي
00:16 - يسجل أحداث المطابقة في Timeline
```

**المرحلة 3: عرض للمستخدم (UI Load)**
```
01:00 - المستخدم يفتح واجهة المعالجة
01:01 - النظام يحمل الضمان + القرار (إن وُجد)
01:02 - يحمل اقتراحات إضافية (حتى لو قرار موجود)
01:03 - يعرض الحالة الحالية
01:04 - يرسم معاينة الخطاب (preview)
```

**المرحلة 4: قرار المستخدم (Decision)**
```
02:00 - المستخدم يراجع البيانات
02:01 - يختار مورد (أو يقبل المقترح)
02:02 - يضغط "حفظ والتالي"
02:03 - النظام يتحقق من تطابق الاسم
02:04 - يحفظ القرار في guarantee_decisions
02:05 - يسجل حدث "قرار" في Timeline
02:06 - يسجل تعلم (confirmation/rejection)
02:07 - ينتقل للسجل التالي
```

**المرحلة 5: الإجراء (Action)**
```
03:00 - المستخدم يقرر تمديد الضمان
03:01 - يضغط زر "تمديد"
03:02 - النظام يتحقق: الحالة = ready؟
03:03 - يحسب تاريخ جديد (+1 سنة)
03:04 - يحفظ الإجراء في guarantee_actions (pending)
03:05 - يسجل حدث "تمديد" في Timeline
03:06 - يحدث المعاينة بالتاريخ الجديد
03:07 - يضع "قفل" (active_action = extension)
```

**المرحلة 6: الطباعة (Letter)**
```
04:00 - المستخدم يضغط "طباعة - تمديد"
04:01 - النظام يولد HTML للخطاب
04:02 - يحفظ نسخة من الـ HTML في Timeline (snapshot)
04:03 - يُعلّم الإجراء كـ "منفذ" (issued)
04:04 - المتصفح يفتح نافذة طباعة
04:05 - المستخدم يطبع
```

---

### أين تتغير الحالة؟

**نقاط تغيير الحالة**:

1. **عند حفظ القرار**:
   - إذا مورد فقط: `pending`
   - إذا مورد + بنك: `ready`

2. **عند الإفراج**:
   - `ready` → `released`
   - لا رجوع

**ما لا يغير الحالة**:
- الاستيراد (لا قرار بعد)
- التمديد/التخفيض (يبقى `ready`)
- تعديل المورد (قد يغير `ready` → `pending` إذا حُذف البنك)

---

### أين تُسجّل؟

**كل شيء يُسجل في Timeline**:
- الاستيراد
- المطابقة التلقائية
- القرار اليدوي
- التمديد/التخفيض/الإفراج
- تغيير الحالة

**بالإضافة**:
- القرارات → `guarantee_decisions`
- الإجراءات → `guarantee_actions`
- التعلم → `learning_confirmations`

---

### أين لا يجوز التعديل بعد نقطة معينة؟

**الخطوط الحمراء**:

1. **بعد الإفراج**: لا شيء يُعدل أبداً
2. **بعد طباعة خطاب**: تعديل البيانات يلغي الخطاب (لكن مسموح)
3. **Timeline**: لا حذف، لا تعديل، أبداً
4. **رقم الضمان**: بعد الحفظ، ثابت

---

## 5. ما الذي لا يجب أن يتغير تحت أي ظرف

### سلوكيات يعتمد عليها المستخدم

1. **"حفظ والتالي" ينتقل دائماً**
   - حتى لو أخطاء، يحفظ ما أمكن وينتقل
   - المستخدم يعتمد على هذا السلوك

2. **الاقتراحات تظهر فوراً عند الكتابة**
   - لو تأخرت، سيكتب المستخدم كل شيء يدوياً
   - السرعة = جوهر القيمة

3. **المعاينة تتحدث في الوقت الفعلي**
   - أي تغيير يُرى فوراً
   - المستخدم يراجع بصرياً

4. **Timeline يظهر كل شيء**
   - المستخدم يثق أن كل حدث محفوظ
   - أي إخفاء = كسر ثقة

---

### منطق التعلم/القفل/Timeline

**منطق التعلم**:
- **لا تغيير**: أبداً في خوارزمية حساب الثقة (confidence)
- **لا تجاهل**: أي قرار مستخدم (يُسجل دائماً)
- **لا نسيان**: التعلم تراكمي

**منطق القفل** (active_action):
- **لو البيانات تغيرت** → القفل يُلغى تلقائياً
- **لو طُبع خطاب** → القفل يُفعّل
- **لا override يدوي**: المستخدم لا يرى/يعدل القفل مباشرة

**منطق Timeline**:
- **كل حدث يُسجل**: لا استثناءات
- **الترتيب الزمني مقدس**: لا إعادة ترتيب
- **Snapshots كاملة**: كل حدث يحفظ نسخة كاملة من البيانات

---

### افتراضات لو كُسرت ينهار النظام

**1. Uniqueness of Guarantee Number**
```
لو سُمح بتكرار رقم ضمان:
  → لا يمكن التمييز بين ضمانين
  → كل الربط سينهار
  → Timeline سيختلط
```

**2. Timeline Immutability**
```
لو سُمح بتعديل Timeline:
  → لا مصداقية للتدقيق
  → لا proof للقرارات
  → انهيار قانوني
```

**3. Status Derivation (not Stored)**
```
لو الحالة صارت مُخزنة (ليست محسوبة):
  → تناقضات (status != reality)
  → bugs خفية
  → منطق العمل ينكسر
```

**4. User Final Authority on Supplier**
```
لو النظام override قرار المستخدم تلقائياً:
  → المستخدم يفقد الثقة
  → يتوقف عن استخدام الاقتراحات
  → يرجع للعمل اليدوي الكامل
```

**5. Bank Matching Determinism**
```
لو مطابقة البنك صارت غير حتمية:
  → نفس الاسم = نتائج مختلفة
  → confusion
  → أخطاء في الخطابات الرسمية
```

---

## الخلاصة: العقد الفكري

هذا النظام **ليس** برنامج إدارة بيانات عادي.

هذا النظام هو **شريك ذكي** يعمل مع الإنسان:
- **يقترح** بناءً على الخبرة المتراكمة
- **ينتظر** قرار الإنسان
- **يتعلم** من كل قرار
- **يوثق** كل شيء
- **يصمت** عندما لا يعرف

**القواعد الجوهرية الثلاث**:

1. **المستخدم صاحب القرار النهائي** - دائماً
2. **Timeline هو الحقيقة المطلقة** - لا تعديل
3. **الحالة نتيجة، ليست مُدخل** - محسوبة

---

**تاريخ الاعتماد**: يُملأ بعد المراجعة  
**الحالة**: ✅ جاهز للمراجعة  
**Next Phase**: Refactor Planning (بعد الاعتماد فقط)
