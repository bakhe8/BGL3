<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BGL3 Diagnostic Report</title>
  <style>
    body { font-family: Arial, sans-serif; background: #0b0f16; color: #e8e8e8; padding: 20px; }
    h1, h2 { color: #00f2ff; }
    .section { margin-bottom: 20px; border: 1px solid #1e2633; padding: 12px; border-radius: 8px; background: #111722; }
    .ok { color: #00ff88; }
    .warn { color: #ffcc00; }
    .fail { color: #ff4d4d; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 6px; border-bottom: 1px solid #1e2633; }
  </style>
</head>
<body>
  <h1>BGL3 Diagnostic Report</h1>
  <div class="section">
    <h2>Summary</h2>
    <p>Timestamp: {{ timestamp }}</p>
    {% if health_score is not none %}
      <p>Health Score: {{ health_score|round(1) }}%</p>
    {% else %}
      <p>Health Score: n/a (no checked routes)</p>
    {% endif %}
    {% if health_score_status %}
      <p>Status: {{ health_score_status }}</p>
    {% endif %}
    {% if route_scan_stats %}
      <p>Route Scan Stats: attempted={{ route_scan_stats.attempted|default(0) }}, checked={{ route_scan_stats.checked|default(0) }}, skipped={{ route_scan_stats.skipped|default(0) }}, errors={{ route_scan_stats.errors|default(0) }}, unknown={{ route_scan_stats.unknown|default(0) }}</p>
    {% endif %}
    <p>Routes scanned: {{ route_scan_limit }} (mode: {{ route_scan_mode }})</p>
    {% if callgraph_meta %}
    <p>Route map: {{ callgraph_meta.total_routes|default(0) }} routes (mapped controllers: {{ callgraph_meta.mapped_controllers|default(0) }})</p>
    {% endif %}
    <p>Execution mode: {{ execution_mode }}</p>
    {% if execution_stats and execution_stats.direct_attempts is defined %}
    <p>Direct attempts recorded: {{ execution_stats.direct_attempts }}</p>
    {% endif %}
    <p>Scan duration: {{ scan_duration_seconds|round(2) }}s (target {{ target_duration_seconds|round(2) }}s)</p>
    {% if audit_status %}
    <p>Audit status: {{ audit_status }}{% if audit_reason %} ({{ audit_reason }}){% endif %}</p>
    {% endif %}
    {% if audit_budget_seconds %}
    <p>Audit budget: {{ audit_budget_seconds|round(1) }}s (elapsed {{ audit_elapsed_seconds|round(1) }}s)</p>
    {% endif %}
    {% if diagnostic_profile %}
    <p>Diagnostic profile: {{ diagnostic_profile }}{% if diagnostic_profile_reason %} ({{ diagnostic_profile_reason }}){% endif %}</p>
    {% endif %}
    {% if diagnostic_profile_overrides %}
    <p>Profile overrides: {{ diagnostic_profile_overrides }}</p>
    {% endif %}
    {% if cache_used %}
    <p>Cache used: {{ cache_used }}{% if cache_reason %} ({{ cache_reason }}){% endif %}</p>
    {% endif %}
    {% if diagnostic_confidence %}
    <p>Diagnostic confidence: {{ diagnostic_confidence.score|default('n/a') }} (profile {{ diagnostic_confidence.profile|default('n/a') }}, route ratio {{ diagnostic_confidence.route_scan_ratio|default('n/a') }})</p>
    {% if diagnostic_confidence.notes %}
      <p class="warn">Confidence notes: {{ diagnostic_confidence.notes }}</p>
    {% endif %}
    {% endif %}
    {% if diagnostic_baseline %}
    <p>Baseline: {{ diagnostic_baseline.profile|default('n/a') }}{% if diagnostic_baseline.timestamp %} at {{ diagnostic_baseline.timestamp }}{% endif %}{% if diagnostic_baseline.age_sec %} (age {{ diagnostic_baseline.age_sec }}s){% endif %}</p>
    {% endif %}
    {% if performance %}
    <p>Perf (home): {% if performance.home_error %}<span class="warn">{{ performance.home_error }}</span>{% else %}{{ performance.home_status|default('n/a') }} in {{ performance.home_load_ms|round(1) }} ms ({{ performance.home_bytes|default(0) }} bytes){% endif %}</p>
    {% endif %}
    {% if api_scan %}
    <p>API scan: mode {{ api_scan.mode }} | checked {{ api_scan.checked }} | skipped {{ api_scan.skipped }} | errors {{ api_scan.errors }}</p>
    {% endif %}
    {% if api_contract %}
    <p>API contract: {{ api_contract.paths|default(0) }} paths ({{ api_contract.source|default('n/a') }})</p>
    {% endif %}
    {% if readiness %}
    <p>Readiness: {{ 'OK' if readiness.ok else 'WARN' }} ({{ readiness.duration_ms }} ms)</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Diagnostic Self Check</h2>
    {% if diagnostic_self_check %}
      <p>Status: <span class="{{ 'ok' if diagnostic_self_check.ok else 'warn' }}">{{ diagnostic_self_check.ok }}</span></p>
      {% if diagnostic_self_check.missing %}
        <p class="warn">Missing fields: {{ diagnostic_self_check.missing | join(', ') }}</p>
      {% endif %}
      {% if diagnostic_self_check.audit_status %}
        <p>Audit status: {{ diagnostic_self_check.audit_status }}{% if diagnostic_self_check.audit_reason %} ({{ diagnostic_self_check.audit_reason }}){% endif %}</p>
      {% endif %}
      {% if diagnostic_self_check.route_scan_stats %}
        <p>Route stats: attempted={{ diagnostic_self_check.route_scan_stats.attempted|default(0) }}, checked={{ diagnostic_self_check.route_scan_stats.checked|default(0) }}, skipped={{ diagnostic_self_check.route_scan_stats.skipped|default(0) }}, errors={{ diagnostic_self_check.route_scan_stats.errors|default(0) }}</p>
      {% endif %}
      {% if diagnostic_self_check.scan_duration_seconds is not none %}
        <p>Scan duration: {{ diagnostic_self_check.scan_duration_seconds|round(2) }}s</p>
      {% endif %}
    {% else %}
      <p class="warn">Diagnostic self check not recorded.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Scenario Run Stats</h2>
    {% if scenario_run_stats %}
      <p>Status: <strong>{{ scenario_run_stats.status|default('n/a') }}</strong></p>
      <p>Attempted: {{ scenario_run_stats.attempted|default(false) }}</p>
      <p>Event delta: {{ scenario_run_stats.event_delta|default(0) }}</p>
      <p>Duration: {{ scenario_run_stats.duration_s|default(0) }}s</p>
      {% if scenario_run_stats.retry_delta is defined %}
        <p>Retry delta: {{ scenario_run_stats.retry_delta }}</p>
        <p>Retry duration: {{ scenario_run_stats.retry_duration_s|default(0) }}s</p>
      {% endif %}
    {% else %}
      <p class="warn">Scenario run stats not recorded.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Coverage Reliability</h2>
    {% if coverage_reliability %}
      <p>Scenario coverage reliable: {{ coverage_reliability.scenario }}</p>
      <p>UI action coverage reliable: {{ coverage_reliability.ui_actions }}</p>
      <p>Flow coverage reliable: {{ coverage_reliability.flow }}</p>
    {% else %}
      <p class="warn">Coverage reliability not recorded.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Diagnostic Faults</h2>
    {% if diagnostic_faults and diagnostic_faults|length > 0 %}
      <ul>
        {% for fault in diagnostic_faults %}
          <li><strong>{{ fault.code }}</strong> ({{ fault.severity }}) — {{ fault.detail }}</li>
        {% endfor %}
      </ul>
    {% else %}
      <p>No diagnostic faults detected.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Automation Status</h2>
    {% if automation %}
      <p>Approvals: <strong>{{ 'ENABLED' if automation.approvals_enabled else 'DISABLED' }}</strong></p>
      <p>Auto Propose: {{ automation.auto_propose }} | min_conf {{ automation.auto_propose_min_conf }} | min_evidence {{ automation.auto_propose_min_evidence }}</p>
      <p>Auto Apply: {{ automation.auto_apply }} | limit {{ automation.auto_apply_limit }}</p>
      <p>Auto Plan: {{ automation.auto_plan }} | limit {{ automation.auto_plan_limit }}</p>
      <p>Auto Digest: {{ automation.auto_digest }} | hours {{ automation.auto_digest_hours }} | limit {{ automation.auto_digest_limit }}</p>
      <p>Auto Verify: {{ automation.auto_verify }} | low_success {{ automation.auto_verify_on_low_success }} (thr {{ automation.auto_verify_success_threshold }})</p>
      <p>Auto Patch: {{ automation.auto_patch_on_errors }} | limit {{ automation.auto_patch_limit }} | min_conf {{ automation.auto_patch_min_conf }}</p>
      <p>Post-Apply: validate {{ automation.post_apply_validate }} (mode {{ automation.post_apply_validate_mode }}) | auto_rollback {{ automation.post_apply_auto_rollback_on_fail }}</p>
      <p>Canary: immediate_eval {{ automation.post_apply_immediate_canary_eval }} | auto_promote_prod {{ automation.post_apply_auto_promote_prod }}</p>
      <p>Execution: mode {{ automation.execution_mode }} | agent_mode {{ automation.agent_mode }} | allow_prod_without_human {{ automation.allow_prod_without_human }}</p>
    {% else %}
      <p class="warn">Automation status not recorded.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Context Digest</h2>
    {% if context_digest %}
      <p>Status: <span class="{{ 'ok' if context_digest.ok else 'warn' }}">{{ context_digest.ok }}</span></p>
      {% if context_digest.hours %}<p>Window: {{ context_digest.hours }} hours</p>{% endif %}
      {% if context_digest.limit %}<p>Limit: {{ context_digest.limit }}</p>{% endif %}
      {% if context_digest.stdout %}<pre>{{ context_digest.stdout }}</pre>{% endif %}
      {% if context_digest.stderr %}<pre class="warn">{{ context_digest.stderr }}</pre>{% endif %}
      {% if context_digest.error %}<p class="warn">Error: {{ context_digest.error }}</p>{% endif %}
    {% else %}
      <p class="warn">Context digest not recorded.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Auto Planning</h2>
    {% if auto_plan %}
      <p>Status: <span class="{{ 'ok' if auto_plan.ok else 'warn' }}">{{ auto_plan.ok }}</span></p>
      {% if auto_plan.generated is not none %}<p>Generated: {{ auto_plan.generated }}</p>{% endif %}
      {% if auto_plan.failed is not none %}<p>Failed: {{ auto_plan.failed }}</p>{% endif %}
      {% if auto_plan.generated_ids %}
        <p>Generated IDs: {{ auto_plan.generated_ids | join(', ') }}</p>
      {% endif %}
      {% if auto_plan.failed_samples %}
        <ul>
          {% for f in auto_plan.failed_samples %}
            <li class="warn">#{{ f.id }} — {{ f.error }}</li>
          {% endfor %}
        </ul>
      {% endif %}
      {% if auto_plan.reason %}<p class="warn">Reason: {{ auto_plan.reason }}</p>{% endif %}
      {% if auto_plan.error %}<p class="warn">Error: {{ auto_plan.error }}</p>{% endif %}
    {% else %}
      <p class="warn">Auto planning not recorded.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>KPI Signals</h2>
    {% if kpi_metrics and kpi_metrics.summary %}
      <p>OK: {{ kpi_metrics.summary.ok|default(0) }} |
         WARN: {{ kpi_metrics.summary.warn|default(0) }} |
         BAD: {{ kpi_metrics.summary.bad|default(0) }} |
         UNKNOWN: {{ kpi_metrics.summary.unknown|default(0) }}</p>
      {% if kpi_metrics.violations %}
        <p><strong>Violations:</strong></p>
        <ul>
          {% for v in kpi_metrics.violations %}
            <li>{{ v.name }} — current {{ v.current }} (target {{ v.target }})</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% else %}
      <p class="warn">KPI metrics not recorded.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Agent Activity Summary</h2>
    {% if activity_summary %}
      <p>Recent activity: {{ activity_summary.recent|default(0) }}</p>
      <p>Last activity: {{ activity_summary.last_activity|default('n/a') }}</p>
      <p>Status: {{ 'STALE' if activity_summary.stale else 'ACTIVE' }}</p>
      {% if activity_summary.top_activity %}
        <p><strong>Top activity:</strong></p>
        <ul>
          {% for a in activity_summary.top_activity %}
            <li>{{ a.name }} — {{ a.count }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% else %}
      <p class="warn">Activity summary not recorded.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Diagnostic Delta Summary</h2>
    {% if diagnostic_delta and diagnostic_delta.summary %}
      <p>Changed keys: {{ diagnostic_delta.summary.changed_keys|default(0) }}</p>
      {% if diagnostic_delta.highlights %}
        <ul>
          {% for h in diagnostic_delta.highlights %}
            <li>{{ h.key }}: {{ h.from }} → {{ h.to }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% else %}
      <p class="warn">Delta summary not recorded.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Baseline Comparison</h2>
    {% if diagnostic_comparison_full and diagnostic_comparison_full.metrics %}
      <ul>
        {% for key, val in diagnostic_comparison_full.metrics.items() %}
          <li><strong>{{ key }}</strong>: {{ val.from }} → {{ val.to }} (Δ {{ val.delta }}, {{ val.classification }})</li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="warn">No baseline comparison available.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Diagnostic Status</h2>
    {% if diagnostic_status %}
      <p>Status: {{ diagnostic_status.status|default('n/a') }}</p>
      {% if diagnostic_status.reason %}
        <p>Reason: {{ diagnostic_status.reason }}</p>
      {% endif %}
      {% if diagnostic_status.started_at %}
        <p>Started: {{ diagnostic_status.started_at }}</p>
      {% endif %}
      {% if diagnostic_status.finished_at %}
        <p>Finished: {{ diagnostic_status.finished_at }}</p>
      {% endif %}
      {% if diagnostic_status.profile %}
        <p>Profile: {{ diagnostic_status.profile }}</p>
      {% endif %}
    {% else %}
      <p class="warn">Diagnostic status not available.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Diagnostic Comparison (Prev vs Current)</h2>
    {% if diagnostic_comparison and diagnostic_comparison.metrics %}
      <ul>
        {% for k, v in diagnostic_comparison.metrics.items() %}
          <li>{{ k }}: {{ v.from }} → {{ v.to }} ({{ v.classification }})</li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="warn">Comparison not recorded.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Failure Taxonomy</h2>
    {% if failure_taxonomy and failure_taxonomy.ok %}
      <p>Lookback: {{ failure_taxonomy.lookback_hours }} hours</p>
      <p>Total failures: {{ failure_taxonomy.total_failures }}</p>
      {% if failure_taxonomy.by_class %}
        <p><strong>By Class:</strong></p>
        <ul>
          {% for k, v in failure_taxonomy.by_class.items() %}
            <li>{{ k }} — {{ v }}</li>
          {% endfor %}
        </ul>
      {% endif %}
      {% if failure_taxonomy.by_operation %}
        <p><strong>Top Operations:</strong></p>
        <ul>
          {% for k, v in failure_taxonomy.by_operation.items() %}
            <li>{{ k }} — {{ v }}</li>
          {% endfor %}
        </ul>
      {% endif %}
      {% if failure_taxonomy.samples %}
        <p><strong>Samples:</strong></p>
        <ul>
          {% for s in failure_taxonomy.samples %}
            <li>{{ s.operation }} | {{ s.class }} | {{ s.result }} — {{ s.notes }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% else %}
      <p class="warn">Failure taxonomy not recorded.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Gap Scenarios</h2>
    {% if gap_scenarios %}
      <p>Generated scenarios: {{ gap_scenarios|length }}</p>
      <ul>
        {% for s in gap_scenarios %}
          <li>{{ s }}</li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="ok">No gap scenarios generated.</p>
    {% endif %}
    {% if gap_scenarios_existing %}
      <p>Existing generated scenarios: {{ gap_scenarios_existing|length }}</p>
      <ul>
        {% for s in gap_scenarios_existing %}
          <li>{{ s }}</li>
        {% endfor %}
      </ul>
    {% endif %}
  </div>

  <div class="section">
    <h2>Run Locks</h2>
    {% if run_locks %}
      <table>
        <tr><th>Lock</th><th>Exists</th><th>PID</th><th>Age (s)</th><th>Label</th></tr>
        {% for k, v in run_locks.items() %}
          <tr>
            <td>{{ k }}</td>
            <td>{{ v.exists }}</td>
            <td>{{ v.pid|default('') }}</td>
            <td>{{ v.age_sec|default('') }}</td>
            <td>{{ v.label|default('') }}</td>
          </tr>
        {% endfor %}
      </table>
    {% else %}
      <p class="warn">Run locks not recorded.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Change Attribution</h2>
    {% if diagnostic_attribution and diagnostic_attribution.classification %}
      <p>Classification: <strong>{{ diagnostic_attribution.classification }}</strong></p>
      {% if diagnostic_attribution.confidence is not none %}
      <p>Confidence: {{ diagnostic_attribution.confidence }}</p>
      {% endif %}
      {% if diagnostic_attribution.window %}
      <p>Window: {{ diagnostic_attribution.window.seconds|default(0)|round(1) }}s</p>
      {% endif %}
      {% if diagnostic_attribution.signals %}
      <p>Signals: changed_keys={{ diagnostic_attribution.signals.changed_keys|default(0) }},
         test_events={{ diagnostic_attribution.signals.test_events|default(0) }},
         write_events={{ diagnostic_attribution.signals.write_events|default(0) }}</p>
      {% endif %}
    {% else %}
      <p class="warn">No attribution recorded.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Authority Matrix</h2>
    {% if authority_matrix %}
      <p>Status: <span class="{{ 'ok' if authority_matrix.ok else 'warn' }}">{{ authority_matrix.ok }}</span></p>
      {% if authority_matrix.warnings %}
        <ul>{% for w in authority_matrix.warnings %}<li class="warn">{{ w }}</li>{% endfor %}</ul>
      {% endif %}
      {% if authority_matrix.protected_prefixes %}
        <p>Protected prefixes: {{ authority_matrix.protected_prefixes | tojson }}</p>
      {% endif %}
    {% else %}
      <p class="warn">Authority matrix not recorded.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Schema Drift</h2>
    {% if schema_drift %}
      <p>Status: <span class="{{ 'ok' if schema_drift.ok else 'warn' }}">{{ schema_drift.ok }}</span></p>
      {% if schema_drift.missing_tables %}
        <p class="warn">Missing tables: {{ schema_drift.missing_tables | tojson }}</p>
      {% endif %}
      {% if schema_drift.missing_columns %}
        <p class="warn">Missing columns: {{ schema_drift.missing_columns | tojson }}</p>
      {% endif %}
      {% if schema_drift.error %}
        <p class="warn">Error: {{ schema_drift.error }}</p>
      {% endif %}
    {% else %}
      <p class="warn">Schema check not recorded.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Domain Rules</h2>
    {% if domain_rule_summary %}
      <p>Violations: {{ domain_rule_summary.count|default(0) }}</p>
      {% if domain_rule_summary.critical_count is defined %}
        <p>Critical: {{ domain_rule_summary.critical_count }}</p>
      {% endif %}
      {% if domain_rule_summary.rule_ids %}
        <p>Rules: {{ domain_rule_summary.rule_ids | join(', ') }}</p>
      {% endif %}
    {% else %}
      <p class="warn">Domain rule summary not recorded.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Volition</h2>
    {% if volition and volition.volition %}
      <p><strong>Focus:</strong> {{ volition.volition }}</p>
      {% if volition.confidence is not none %}
      <p>Confidence: {{ volition.confidence }}</p>
      {% endif %}
      {% if volition.source %}
      <p>Source: {{ volition.source }}</p>
      {% endif %}
    {% else %}
      <p class="warn">No volition recorded.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Effective Config (Sources)</h2>
    {% if effective_config %}
      <p>Config source: <code>.bgl_core/config.yml</code> + <code>storage/agent_flags.json</code></p>
      {% if effective_config._sources %}
      <table>
        <tr><th>Key</th><th>Value</th><th>Source</th></tr>
        {% for key, source in effective_config._sources.items() %}
          {% set val = effective_config %}
          {% for part in key.split('.') %}
            {% if val is mapping and part in val %}
              {% set val = val[part] %}
            {% else %}
              {% set val = '' %}
            {% endif %}
          {% endfor %}
          <tr>
            <td><code>{{ key }}</code></td>
            <td>{{ val }}</td>
            <td>{{ source }}</td>
          </tr>
        {% endfor %}
      </table>
      {% else %}
      <p class="warn">Effective config sources not available.</p>
      {% endif %}
    {% else %}
      <p class="warn">Effective config not recorded.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Autonomous Policy</h2>
    {% if autonomous_policy and autonomous_policy.status %}
      <p>Status: {{ autonomous_policy.status }}</p>
      {% if autonomous_policy.action %}
      <p>Action: {{ autonomous_policy.action }}</p>
      {% endif %}
      {% if autonomous_policy.added %}
      <p>Added: {{ autonomous_policy.added|length }}</p>
      {% endif %}
      {% if autonomous_policy.updated %}
      <p>Updated: {{ autonomous_policy.updated|length }}</p>
      {% endif %}
      {% if autonomous_policy.removed %}
      <p>Removed: {{ autonomous_policy.removed|length }}</p>
      {% endif %}
    {% else %}
      <p class="warn">No autonomous policy changes.</p>
    {% endif %}
  </div>

  <!-- Pending Approvals removed: approvals are automated. -->

  <div class="section">
    <h2>Recent Outcomes</h2>
    {% if recent_outcomes %}
      <table>
        <tr><th>Outcome</th><th>Result</th><th>Intent</th><th>Decision</th><th>Notes</th><th>Fallback Context</th></tr>
        {% for o in recent_outcomes %}
          <tr>
            <td>{{ o.outcome_id }}</td>
            <td class="{{ 'ok' if o.outcome_result in ['success','success_with_override','success_direct'] else ('warn' if o.outcome_result in ['blocked','skipped'] else 'fail') }}">{{ o.outcome_result }}</td>
            <td><code>{{ o.intent_value }}</code></td>
            <td>{{ o.decision_value }}{% if o.risk_level %} ({{ o.risk_level }}){% endif %}</td>
            <td>{{ o.outcome_notes }}</td>
            <td>{% if o.fallback_ctx %}{{ o.fallback_ctx | tojson }}{% endif %}</td>
          </tr>
        {% endfor %}
      </table>
    {% else %}
      <p class="ok">No outcomes recorded.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Readiness Gate</h2>
    {% if readiness %}
      <p class="{{ 'ok' if readiness.ok else 'warn' }}">Overall: {{ readiness.ok }}</p>
      <table>
        <tr><th>Service</th><th>Status</th><th>Detail</th></tr>
        <tr>
          <td>base_http</td>
          <td class="{{ 'ok' if readiness.services.base_http.ok else 'fail' }}">{{ readiness.services.base_http.ok }}</td>
          <td>{{ readiness.services.base_http.url }}{% if readiness.services.base_http.error %} — {{ readiness.services.base_http.error }}{% endif %}</td>
        </tr>
        <tr>
          <td>tool_server</td>
          <td class="{{ 'ok' if readiness.services.tool_server.ok else 'fail' }}">{{ readiness.services.tool_server.ok }}</td>
          <td>port {{ readiness.services.tool_server.port }}{% if readiness.services.tool_server.detail %} — {{ readiness.services.tool_server.detail }}{% endif %}</td>
        </tr>
        <tr>
          <td>local_llm</td>
          <td class="{{ 'ok' if readiness.services.local_llm.ok else 'warn' }}">{{ readiness.services.local_llm.ok }}</td>
          <td>{{ readiness.services.local_llm.base_url }} | model {{ readiness.services.local_llm.model }} | warmed {{ readiness.services.local_llm.warmed }}{% if readiness.services.local_llm.error %} — {{ readiness.services.local_llm.error }}{% endif %}</td>
        </tr>
      </table>
    {% else %}
      <p class="warn">Readiness gate not executed.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Scenario Readiness</h2>
    {% if scenario_deps %}
      {% if scenario_deps.ok %}
        <p class="ok">Dependencies OK</p>
      {% else %}
        <p class="warn">Missing: {{ scenario_deps.missing|join(', ') }}</p>
      {% endif %}
      {% if scenario_deps.playwright_version %}<p>Playwright: {{ scenario_deps.playwright_version }}</p>{% endif %}
      {% if scenario_deps.chromium_path %}<p>Chromium: {{ scenario_deps.chromium_path }}</p>{% endif %}
      {% if scenario_deps.notes %}
        <ul>{% for n in scenario_deps.notes %}<li class="warn">{{ n }}</li>{% endfor %}</ul>
      {% endif %}
    {% else %}
      <p class="warn">Scenario deps not checked.</p>
    {% endif %}
    {% if runtime_events_meta %}
      <p>Runtime events: {{ runtime_events_meta.count|default(0) }}</p>
      <p>Last event timestamp: {{ runtime_events_meta.last_timestamp|default('n/a') }}</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Scenario Coverage</h2>
    {% if scenario_coverage %}
      <p>Window: {{ scenario_coverage.window_days|default(0) }} days</p>
      <p>Routes covered: {{ scenario_coverage.covered_routes|default(0) }} / {{ scenario_coverage.total_routes|default(0) }} ({{ scenario_coverage.coverage_ratio|default(0) }}%)</p>
      <p>UI snapshot paths: {{ scenario_coverage.ui_snapshot_paths|default(0) }} ({{ scenario_coverage.ui_coverage_ratio|default(0) }}%)</p>
      {% if scenario_coverage.gap_runs is not none %}
        <p>Gap scenarios run: {{ scenario_coverage.gap_runs|default(0) }}{% if scenario_coverage.gap_changed is not none %} (changed {{ scenario_coverage.gap_changed|default(0) }}){% endif %}</p>
      {% endif %}
      {% if scenario_coverage.uncovered_sample %}
        <p class="warn">Uncovered sample:</p>
        <ul>
          {% for u in scenario_coverage.uncovered_sample %}
            <li>{{ u.route }} ({{ u.method }})</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% else %}
      <p class="warn">Coverage not recorded.</p>
    {% endif %}
    {% if coverage_gate and coverage_gate.route_ratio is not none %}
      <p><strong>Coverage Gate:</strong> route {{ coverage_gate.route_ratio }}% / {{ coverage_gate.min_route_ratio }}%, UI {{ coverage_gate.ui_ratio }}% / {{ coverage_gate.min_ui_ratio }}% → {{ "OK" if coverage_gate.ok else "WARN" }}</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>UI Action Coverage</h2>
    {% if ui_action_coverage %}
      <p>Window: {{ ui_action_coverage.window_days|default(0) }} days</p>
      <p>Actions covered: {{ ui_action_coverage.covered_actions|default(0) }} / {{ ui_action_coverage.total_actions|default(0) }} ({{ ui_action_coverage.coverage_ratio|default(0) }}%)</p>
      <p>Routes with actions: {{ ui_action_coverage.routes_with_actions|default(0) }} (covered {{ ui_action_coverage.routes_with_coverage|default(0) }})</p>
      {% if ui_action_coverage.uncovered_sample %}
        <p class="warn">Uncovered actions (sample):</p>
        <ul>
          {% for u in ui_action_coverage.uncovered_sample %}
            <li>{{ u.route }} — {{ u.text or u.href or u.selector }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% else %}
      <p class="warn">UI action coverage not recorded.</p>
    {% endif %}
    {% if coverage_gate and coverage_gate.ui_action_ratio is not none %}
      <p><strong>UI Action Gate:</strong> {{ coverage_gate.ui_action_ratio }}% / {{ coverage_gate.min_ui_action_ratio }}% → {{ "OK" if coverage_gate.ok else "WARN" }}</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Flow Coverage</h2>
    {% if flow_coverage %}
      <p>Window: {{ flow_coverage.window_days|default(0) }} days</p>
      <p>Flows covered: {{ flow_coverage.covered_flows|default(0) }} / {{ flow_coverage.total_flows|default(0) }} ({{ flow_coverage.coverage_ratio|default(0) }}%)</p>
      <p>Flow sequences covered: {{ flow_coverage.sequence_covered_flows|default(0) }} ({{ flow_coverage.sequence_coverage_ratio|default(0) }}%)</p>
      {% if flow_coverage.gap_runs is not none %}
        <p>Flow gap runs: {{ flow_coverage.gap_runs|default(0) }}{% if flow_coverage.gap_changed is not none %} (changed {{ flow_coverage.gap_changed|default(0) }}){% endif %}</p>
      {% endif %}
      {% if flow_coverage.uncovered_sample %}
        <p class="warn">Uncovered flows:</p>
        <ul>
          {% for f in flow_coverage.uncovered_sample %}
            <li>{{ f.flow }} ({{ f.status }}){% if f.endpoints %} — {{ f.endpoints | join(', ') }}{% endif %}</li>
          {% endfor %}
        </ul>
      {% endif %}
      {% if flow_coverage.schema_errors %}
        <p class="warn">Flow schema errors:</p>
        <ul>
          {% for e in flow_coverage.schema_errors %}
            <li>{{ e.file }} — {{ e.errors | join(', ') }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% else %}
      <p class="warn">Flow coverage not recorded.</p>
    {% endif %}
    {% if flow_gate and flow_gate.flow_ratio is not none %}
      <p><strong>Flow Gate:</strong> flow {{ flow_gate.flow_ratio }}% / {{ flow_gate.min_flow_ratio }}%, sequence {{ flow_gate.sequence_ratio }}% / {{ flow_gate.min_sequence_ratio }}% → {{ "OK" if flow_gate.ok else "WARN" }}</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Auto Insights</h2>
    {% if auto_insights_status and auto_insights_status.total is defined %}
      <p>Loaded: {{ auto_insights_status.loaded|default(0) }} / {{ auto_insights_status.total|default(0) }}</p>
      <table>
        <tr><th>Metric</th><th>Count</th></tr>
        <tr><td>Stale</td><td>{{ auto_insights_status.stale|default(0) }}</td></tr>
        <tr><td>Missing Meta</td><td>{{ auto_insights_status.missing_meta|default(0) }}</td></tr>
        <tr><td>Missing Source</td><td>{{ auto_insights_status.missing_source|default(0) }}</td></tr>
        <tr><td>Nested</td><td>{{ auto_insights_status.nested|default(0) }}</td></tr>
        <tr><td>Duplicate</td><td>{{ auto_insights_status.duplicate|default(0) }}</td></tr>
        <tr><td>Expired</td><td>{{ auto_insights_status.expired|default(0) }}</td></tr>
        <tr><td>Skipped (Limit)</td><td>{{ auto_insights_status.skipped_limit|default(0) }}</td></tr>
      </table>
    {% else %}
      <p class="warn">Auto insights status not recorded.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>UI Semantic</h2>
    {% if ui_semantic and ui_semantic.summary %}
      <p><strong>URL:</strong> {{ ui_semantic.url }}</p>
      <p><strong>Title:</strong> {{ ui_semantic.summary.title }}</p>
      {% if ui_semantic.summary.page_type %}
        <p><strong>Page Type:</strong> {{ ui_semantic.summary.page_type }}</p>
      {% endif %}
      {% if ui_semantic.summary.headings %}
        <p><strong>Headings:</strong> {{ ui_semantic.summary.headings | tojson }}</p>
      {% endif %}
      {% if ui_semantic.summary.nav_items %}
        <p><strong>Nav Items:</strong> {{ ui_semantic.summary.nav_items | tojson }}</p>
      {% endif %}
      {% if ui_semantic.summary.breadcrumbs %}
        <p><strong>Breadcrumbs:</strong> {{ ui_semantic.summary.breadcrumbs | tojson }}</p>
      {% endif %}
      {% if ui_semantic.summary.tables %}
        <p><strong>Tables:</strong> {{ ui_semantic.summary.tables | tojson }}</p>
      {% endif %}
      {% if ui_semantic.summary.forms %}
        <p><strong>Forms:</strong> {{ ui_semantic.summary.forms | tojson }}</p>
      {% endif %}
      {% if ui_semantic.summary.primary_actions %}
        <p><strong>Primary Actions:</strong> {{ ui_semantic.summary.primary_actions | tojson }}</p>
      {% endif %}
      {% if ui_semantic.summary.search_fields %}
        <p><strong>Search Fields:</strong> {{ ui_semantic.summary.search_fields | tojson }}</p>
      {% endif %}
      {% if ui_semantic.summary.text_keywords %}
        <p><strong>Keywords:</strong> {{ ui_semantic.summary.text_keywords | join(', ') }}</p>
      {% endif %}
      {% if ui_semantic.summary.text_blocks %}
        <p><strong>Text Blocks:</strong> {{ ui_semantic.summary.text_blocks | tojson }}</p>
      {% endif %}
      {% if ui_semantic.summary.ui_states %}
        <p><strong>UI States:</strong> {{ ui_semantic.summary.ui_states | tojson }}</p>
      {% endif %}
      {% if ui_semantic_delta and ui_semantic_delta.changed %}
        <p class="warn"><strong>Delta:</strong> Changes detected</p>
        <pre>{{ ui_semantic_delta | tojson(indent=2) }}</pre>
      {% else %}
        <p class="ok">No semantic changes detected.</p>
      {% endif %}
    {% else %}
      <p class="warn">No UI semantic snapshot available.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Self Policy</h2>
    {% if self_policy %}
      {% if self_policy.semantic_thresholds %}
        <p><strong>Semantic thresholds:</strong> {{ self_policy.semantic_thresholds | tojson }}</p>
      {% endif %}
      {% if self_policy.intent_bias %}
        <p><strong>Intent bias:</strong> {{ self_policy.intent_bias | tojson }}</p>
      {% endif %}
      {% if self_policy.last_updated %}
        <p>Last updated: {{ self_policy.last_updated }}</p>
      {% endif %}
    {% else %}
      <p class="warn">No self policy recorded.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Fallback Rules (Signals)</h2>
    {% if fallback_rules_summary %}
      {% if fallback_rules_summary.total is not none %}
        <p><strong>Total rules:</strong> {{ fallback_rules_summary.total }}</p>
      {% endif %}
      {% if fallback_rules_summary.by_source %}
        <p><strong>By source:</strong> {{ fallback_rules_summary.by_source | tojson }}</p>
      {% endif %}
      {% if fallback_rules_summary.code_intent_samples %}
        <p><strong>Code intent samples:</strong></p>
        <pre>{{ fallback_rules_summary.code_intent_samples | tojson(indent=2) }}</pre>
      {% endif %}
    {% else %}
      <p class="warn">No fallback rule summary available.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Self Rules</h2>
    {% if self_rules %}
      {% if self_rules.rules %}
        <p><strong>Rules:</strong> {{ self_rules.rules | tojson }}</p>
      {% endif %}
      {% if self_rules.overrides %}
        <p><strong>Overrides:</strong> {{ self_rules.overrides | tojson }}</p>
      {% endif %}
      {% if self_rules.last_updated %}
        <p>Last updated: {{ self_rules.last_updated }}</p>
      {% endif %}
    {% else %}
      <p class="warn">No self rules recorded.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Tool Evidence</h2>
    {% if tool_evidence %}
      {% if tool_evidence.route_index %}
      <h3>Route Index</h3>
      <pre>{{ tool_evidence.route_index | tojson(indent=2) }}</pre>
      {% endif %}
      {% if tool_evidence.run_checks %}
      <h3>Run Checks</h3>
      <pre>{{ tool_evidence.run_checks | tojson(indent=2) }}</pre>
      {% endif %}
    {% else %}
      <p>No tool evidence captured.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Vitals</h2>
    <ul>
      <li>Infrastructure: <span class="{{ 'ok' if vitals.infrastructure else 'fail' }}">{{ vitals.infrastructure }}</span></li>
      <li>Business Logic: <span class="{{ 'ok' if vitals.business_logic else 'warn' }}">{{ vitals.business_logic }}</span></li>
      <li>Architecture: <span class="{{ 'ok' if vitals.architecture else 'fail' }}">{{ vitals.architecture }}</span></li>
    </ul>
  </div>

  <div class="section">
    <h2>Permission Issues</h2>
    {% if permission_issues %}
      <ul>{% for p in permission_issues %}<li class="warn">{{ p }}</li>{% endfor %}</ul>
    {% else %}<p class="ok">None</p>{% endif %}
  </div>

  <div class="section">
    <h2>Failing Routes</h2>
    {% if failing_routes %}
      <table>
        <tr><th>URI</th><th>Errors</th></tr>
        {% for fr in failing_routes %}
          <tr><td>{{ fr.uri }}</td><td>{{ fr.errors|join('; ') }}</td></tr>
        {% endfor %}
      </table>
    {% else %}<p class="ok">All healthy</p>{% endif %}
  </div>

  <div class="section">
    <h2>Expected Failures (Policy)</h2>
    {% if expected_failures %}
      <table>
        <tr><th>URI</th><th>Method</th><th>Status</th><th>Reason</th></tr>
        {% for e in expected_failures %}
          <tr><td>{{ e.uri }}</td><td>{{ e.method }}</td><td>{{ e.status }}</td><td>{{ e.reason }}</td></tr>
        {% endfor %}
      </table>
    {% else %}<p class="ok">None</p>{% endif %}
  </div>

  <div class="section">
    <h2>Policy Candidates (Evidence)</h2>
    {% if policy_candidates %}
      <table>
        <tr><th>URI</th><th>Method</th><th>Status</th><th>Confidence</th><th>Evidence</th></tr>
        {% for c in policy_candidates %}
          <tr>
            <td>{{ c.uri }}</td>
            <td>{{ c.method }}</td>
            <td>{{ c.status }}</td>
            <td>{{ c.confidence }}</td>
            <td>{{ c.evidence|join('; ') }}</td>
          </tr>
        {% endfor %}
      </table>
    {% else %}<p class="ok">None</p>{% endif %}
  </div>

  <div class="section">
    <h2>Policy Auto-Promoted</h2>
    {% if policy_auto_promoted %}
      <table>
        <tr><th>URI</th><th>Method</th><th>Status</th><th>Reason</th></tr>
        {% for p in policy_auto_promoted %}
          <tr><td>{{ p.uri }}</td><td>{{ p.method }}</td><td>{{ p.expected_statuses|join(',') }}</td><td>{{ p.reason }}</td></tr>
        {% endfor %}
      </table>
    {% else %}<p class="ok">None</p>{% endif %}
  </div>

  <div class="section">
    <h2>API Contract Missing</h2>
    {% if api_contract_missing %}
      <table>
        <tr><th>URI</th><th>Method</th><th>File</th></tr>
        {% for m in api_contract_missing %}
          <tr><td>{{ m.uri }}</td><td>{{ m.http_method }}</td><td>{{ m.file_path }}</td></tr>
        {% endfor %}
      </table>
    {% else %}<p class="ok">None</p>{% endif %}
  </div>

  <div class="section">
    <h2>API Contract Gaps</h2>
    {% if api_contract_gaps %}
      <table>
        <tr><th>URI</th><th>Method</th><th>Reason</th></tr>
        {% for g in api_contract_gaps %}
          <tr><td>{{ g.uri }}</td><td>{{ g.http_method }}</td><td>{{ g.reason }}</td></tr>
        {% endfor %}
      </table>
    {% else %}<p class="ok">None</p>{% endif %}
  </div>

  <div class="section">
    <h2>Worst Routes (by recent errors/latency)</h2>
    {% if worst_routes %}
      <ul>{% for wr in worst_routes %}<li>{{ wr.uri }} — score {{ wr.score }}</li>{% endfor %}</ul>
    {% else %}<p>No hot routes.</p>{% endif %}
  </div>

  <div class="section">
    <h2>Recent Experiences</h2>
    {% if experiences %}
      <ul>{% for e in experiences %}<li>{{ e.scenario }} — {{ e.summary }}</li>{% endfor %}</ul>
    {% else %}<p>No experiences recorded.</p>{% endif %}
  </div>

  <div class="section">
    <h2>Suggestions</h2>
    {% if suggestions %}
      <ul>{% for s in suggestions %}<li>{{ s }}</li>{% endfor %}</ul>
    {% else %}<p class="ok">No suggestions.</p>{% endif %}
  </div>

  <div class="section">
    <h2>Intent & Decision</h2>
    {% if intent %}
      <p><strong>Intent:</strong> {{ intent.intent }} ({{ (intent.confidence * 100)|round(1) }}%)</p>
      <p><strong>Reason:</strong> {{ intent.reason }}</p>
      <p><strong>Scope:</strong> {{ intent.scope }}</p>
      {% if intent.maturity %}<p><strong>Maturity:</strong> {{ intent.maturity.level|default('experimental') }}</p>{% endif %}
      {% if intent.conflicts_with %}<p><strong>Conflicts:</strong> {{ intent.conflicts_with|length }}</p>{% endif %}
    {% else %}
      <p>لا يوجد intent مسجل.</p>
    {% endif %}
    {% if decision %}
      <p><strong>Decision:</strong> {{ decision.decision }}</p>
      <p><strong>Risk:</strong> {{ decision.risk_level }}</p>
      <p><strong>Requires Human:</strong> {{ decision.requires_human }}</p>
      {% if decision.justification %}<p><strong>Justification:</strong> {{ decision.justification|join('; ') }}</p>{% endif %}
      {% if decision.maturity %}<p><strong>Decision Maturity:</strong> {{ decision.maturity.level|default('experimental') }}</p>{% endif %}
      {% if decision.conflicts_with %}<p><strong>Conflicts:</strong> {{ decision.conflicts_with|length }}</p>{% endif %}
      {% if decision.explanation %}
        <div style="margin-top:8px;">
          <p><strong>Decision Explanation</strong></p>
          {% if decision.explanation.reasons %}
            <p><strong>Reasons:</strong> {{ decision.explanation.reasons | join('; ') }}</p>
          {% endif %}
          {% if decision.explanation.alternatives %}
            <p><strong>Alternatives:</strong> {{ decision.explanation.alternatives | join('; ') }}</p>
          {% endif %}
          {% if decision.explanation.expected_outcomes %}
            <p><strong>Expected Outcomes:</strong> {{ decision.explanation.expected_outcomes | join('; ') }}</p>
          {% endif %}
          {% if decision.explanation.context %}
            <p><strong>Context:</strong> {{ decision.explanation.context | tojson }}</p>
          {% endif %}
        </div>
      {% endif %}
    {% endif %}
  </div>

  <div class="section">
    <h2>Interpretation (Executive Summary)</h2>
    {% if interpretation.items_list %}
      <ul>{% for i in interpretation.items_list %}<li>{{ i }}</li>{% endfor %}</ul>
    {% else %}
      <p>لا يوجد تفسير إضافي.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Gap Tests</h2>
    {% if gap_tests %}
      <ul>{% for g in gap_tests %}<li>{{ g.id if g.id else 'gap' }} — {{ 'PASS' if g.passed else 'FAIL' }} {% if g.evidence %}(evidence: {{ g.evidence }}){% endif %}</li>{% endfor %}</ul>
    {% else %}
      <p>No gap tests recorded.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>External Checks (Patterns)</h2>
    {% if external_checks %}
      <ul>
      {% for c in external_checks %}
        {% set cls = 'ok' if c.passed else 'warn' %}
        <li class="{{ cls }}">
          {{ c.id or c.check or 'check' }} — {{ 'PASS' if c.passed else 'WARN/FAIL' }}
          {% if c.evidence %}( {{ c.evidence|join('; ') }} ){% endif %}
        </li>
      {% endfor %}
      </ul>
    {% else %}
      <p class="ok">لا توجد تحذيرات خارجية.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Proposals</h2>
    {% if proposals %}
      <ul>
        {% for p in proposals %}
          <li>
            {{ p.name or p.id or 'proposal' }}
            {% if p.recommendation %}: {{ p.recommendation }}{% endif %}
            {% if p.maturity %} (maturity: {{ p.maturity.level|default('experimental') }}){% endif %}
            {% if p.conflicts_with %} | conflicts: {{ p.conflicts_with|length }}{% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}<p>No proposals.</p>{% endif %}
  </div>

  <div class="section">
    <h2>Unified Actions</h2>
    {% if unified_actions %}
      <ul>
        {% for a in unified_actions %}
          <li>
            <strong>{{ a.kind }}</strong>
            {% if a.title %}: {{ a.title }}{% endif %}
            {% if a.severity %} ({{ a.severity }}){% endif %}
            {% if a.source %} — source: {{ a.source }}{% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="ok">No unified actions.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Decision Explanations (Recent)</h2>
    {% if decision_explanations %}
      <ul>
        {% for d in decision_explanations %}
          <li>
            {{ d.intent or 'intent' }} → {{ d.decision or 'decision' }}
            {% if d.result %} ({{ d.result }}){% endif %}
            {% if d.reason %} — {{ d.reason }}{% endif %}
            {% if d.notes %} — {{ d.notes }}{% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="ok">No decision explanations.</p>
    {% endif %}
  </div>
</body>
</html>
