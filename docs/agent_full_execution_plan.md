# خطة التنفيذ الكاملة لوكيل BGL3 (منظمة ومحدّثة)

**التاريخ:** 2026-02-09  
**الهدف النهائي:** وكيل يعمل كـ “بلوق حي” لمشروع قائم: يفهم الكود والواجهة والسلوك runtime، يكتشف الفجوات، يقترح الإصلاحات، ينفّذها بأمان، ويقيس الأثر بدقة.  
**اتفاق الإنهاء:** عند تحقق معايير DoD كاملة، يُعتبر الوكيل جاهزًا ولا تُجرى تطويرات إضافية إلا بطلب جديد صريح.

---

## 1) الوضع الحالي (مختصر بدون تشغيل فحوصات جديدة)
- **context_digest** يتأخر أحيانًا بسبب المهلة ويحتاج ضبط استمراريته.
- **success_rate** أقل من الهدف في DoD.
- **السجل السببي** تحسّن لكنه يحتاج توحيد الربط داخل الذاكرة.
- **حلقة التعلّم الذاتية** تعمل جزئيًا وتحتاج تثبيت في كل المسارات.
- **سياسة الأهداف طويلة المدى** تحتاج جدولة وربط أقوى بالاستكشاف.
- **الفحوصات قد تتعطّل بسبب تدخل بشري غير مقصود** (إغلاق نافذة أثناء التشغيل).

---

## 2) مبادئ التنفيذ (غير قابلة للتجاوز)
- لا يتم تشغيل أي فحوصات/تشخيصات جديدة إلا بعد موافقة صريحة من صاحب المشروع.
- التغيير يُفعّل عبر القدرات الموجودة أولًا قبل بناء جديد.
- الربط يكون **شاملًا عبر الذاكرة** وليس فقط عبر التقرير.
- أي نتيجة جزئية تُوسم بوضوح حتى لا تُقرأ كنهائية.

---

## 3) خطة توحيد تنفيذ الفحوصات + ربطها بالذاكرة (محور تشغيل جديد)

**الهدف:** تشغيل آلي بدون انتظار يدوي، مع تمييز الجديد عن القديم، وربط ذلك بذاكرة الوكيل وفهمه.

### 3.1 النقاط الخمس الأساسية (تنفيذ موحّد)
1) **تشغيل مجدول + سجل حالة التشغيل**  
   - **تم:** سجل حالة تشغيل مركزي عبر `diagnostic_status.json` (running/cached/timeout/complete).
2) **تقرير مرحلي (Checkpoint)**  
   - **تم:** `diagnostic_checkpoint` في `runtime_events` (profile/scenarios/route_scan).
3) **فحص سريع تلقائي + فحص كامل دوري**  
   - **تم برمجيًا:** وضع `fast` يعمل بمسح محدود (scan) بدل التعليق/الـ stub.
4) **إشعار اكتمال الفحص**  
   - **تم:** `diagnostic_run_complete` + تحديث status.
5) **Auto-timeout + تقرير جزئي**  
   - **تم:** budget داخل `guardian` + fallback على تقرير مخزّن عند timeout.

### 3.2 دلتا واضحة (الجديد vs القديم)
- **تم:** مقارنة تلقائية بين آخر تقريرين داخل `diagnostic_comparison`.
- تصنيف التغيّر: `improvement`, `regression`, `noise`.
- **تم:** حفظ baseline مستقل (Full فقط) + مقارنة baseline داخل التقرير.

### 3.3 تمكين الضبط الآمن لحدود الفحوصات (الوقت/المسارات/السيناريوهات)
- تمكين الوكيل من ضبط:
  - `diagnostic_timeout_sec`
  - `route_scan_limit`
  - `route_scan_max_seconds`
  - `scenario_batch_limit`
- التعديل يتم عبر **مسار آمن** فقط: `storage/agent_flags.json`.
- التعديل يعتمد على نتائج التشغيل السابقة (مدة الفحص، نسبة النجاح، نسبة التوقف).
  - **تم:** عبر `config_tuner.py` (SAFE_KEYS).

### 3.4 ربط الفحوصات بمسار الذاكرة والفهم
- تسجيل أحداث الفحوصات في `runtime_events`:
  - `diagnostic_run_started`
  - `diagnostic_checkpoint`
  - `diagnostic_run_complete`
  - `diagnostic_delta`
- تحويل هذه الأحداث تلقائيًا عبر `context_digest` إلى Experiences.
- ربطها بـ `decision_traces` كي يقرأ الوكيل أثرها عند التخطيط أو التصحيح.
  - **تم:** الأحداث + التحويل عبر `context_digest.py` + `decision_traces`.

### 3.5 طبقة حماية الفحوصات (منع الأخطاء غير المقصودة)
- **تم:** تأجيل الفحص تلقائيًا عند نشاط المستخدم (`diagnostic_idle_guard_sec`).
- **تم:** كشف الإنهاء القسري وتحويله إلى `aborted` بدل نتائج مضللة.
- **تم:** عدم تحديث baseline إلا عند ثقة كافية (`diagnostic_confidence >= 0.7`).
- **تم:** تشغيل الخلفية بدون نافذة عبر daemon.

### 3.6 تصنيف أخطاء الفحوصات (Fault Taxonomy)
- **تم:** إضافة `diagnostic_faults` مع أسباب واضحة (timeout/aborted/low_events/low_coverage).
- تُسجَّل للوكيل ضمن snapshots حتى لا يبني قرارات على فحص معيوب.

---

## 4) البنود المتبقية من الخطة الأصلية (مرتبة حسب الأثر)

### 4.0 ترتيب الأولويات المتبقية (مختصر وواضح)
1) **رفع التغطية التشغيلية** (UI Action Coverage + Flow Coverage) لأنها شرط أساسي لقراءة الأثر الحقيقي.  
2) **إغلاق Gap Loop فعليًا** (تشغيل gaps وربطها بالتغطية والذاكرة).  
3) **Semantic Delta** لإثبات تغيّر دلالي فعلي بعد الاستكشاف.  
4) **Proposals مستمرة** مع أثر واضح في السجل.  
5) **Canary/Rollback** فعّال على بيانات تشغيلية حقيقية.

### 4.1 ثبات التشغيل والقياس
> **ملاحظة:** هذه البنود أصبحت مفعّلة برمجيًا، ولا ينقصها إلا تحقق تشغيلي عند تشغيل الفحوصات.

- **Timeouts/Guards تشغيلية**: **باقي تحقق تشغيلي** لإثبات عدم التعليق الصامت.
- **C4 اختبار سياقي بعد التعديل**: **تم برمجيًا** (Contextual checks حسب الملفات المتغيّرة) + **يتطلب تحقق تشغيلي**.
- **C5 Runtime Profiling**: **تم برمجيًا** (تسجيل `runtime_profile_snapshot` ضمن runtime_events) + **يتطلب تحقق تشغيلي**.
- **C6 Safe Patch Intelligence**: **تم برمجيًا** (تجميد الترويج عالي/متوسط المخاطر حتى تتوفر بيانات تشغيل كافية) + **يتطلب تحقق تشغيلي**.

### 4.2 تغطية الاستكشاف
- **UI Action Coverage**: رفع التغطية التشغيلية وليس النظرية.  
  الحالة: **تم برمجيًا تعزيز الربط** (اعتماد snapshots + semantic تغيّر) + **يتطلب تحقق تشغيلي**.
- **Flow Coverage**: توحيد flows وربطها بأحداث runtime حقيقية.  
  الحالة: **تم برمجيًا تعزيز الربط** (events + snapshots + semantic تغيّر) + **يتطلب تحقق تشغيلي**.
- **Gap Loop**: توليد gaps وتشغيلها تلقائيًا مع تسجيل الأثر.  
  الحالة: **تم برمجيًا تعزيز ربط النتائج بالتغطية** + **يتطلب تحقق تشغيلي**.
- **Semantic Delta**: إثبات تغيّر دلالي فعلي في الاستكشاف.  
  الحالة: **تم برمجيًا تعزيز احتساب التغيّر** + **يتطلب تحقق تشغيلي**.

### 4.3 Loop & Canary
- **Proposals مستمرة**: proposals > 0 أسبوعيًا مع أثر واضح.  
  الحالة: **تم برمجيًا ربطها بالتغطية التشغيلية** + تحتاج ثبات تشغيل.
- **Canary/Rollback**: تقييم دوري تلقائي + rollback عند التدهور.  
  الحالة: مفعّل برمجيًا لكن يحتاج بيانات تشغيل كافية.

---

## 4.4 ما تبقّى فعليًا الآن (تشغيلي فقط)
- **تشغيل فحص واحد** للتأكد أن:
  - `ui_action_snapshot` و `ui_semantic_snapshot` تُسجّل كـ runtime_events.
  - `ui_action_coverage` و `flow_coverage` تظهر مع **operational_coverage_ratio**.
  - `gap_coverage_refresh` يظهر بعد gap run (لو تم تشغيل gaps).
- لا يوجد أي بناء جديد مطلوب في هذه النقطة.
> ملاحظة: بعد إضافة الحمايات والتصنيفات، أي فحص ناقص/متأثر بالنشاط البشري سيتم وسمه تلقائيًا ولن يُستخدم كمرجع.

---

## 4.5 خطة تشغيل تحقق واحدة (عند الموافقة)
**الهدف:** إثبات أن البنود التشغيلية تعمل كما هو متوقع، دون تشغيل متكرر أو طويل.

1) تشغيل تقرير واحد فقط (full diagnostic) بعد الموافقة.  
2) استخراج المؤشرات التالية من `latest_report.json`:  
   - `ui_action_coverage.operational_coverage_ratio`  
   - `flow_coverage.operational_coverage_ratio`  
   - `ui_semantic_delta.changed` + `change_count`  
   - وجود `gap_coverage_refresh` في runtime_events  
3) مقارنة النتائج قبل/بعد في `diagnostic_comparison`.

---

## 5) Definition of Done (DoD)
**الهدف:** تعريف نهاية البناء بمؤشرات واضحة.

1) success_rate ≥ 0.75 لمدة 7 أيام متواصلة  
2) لا skipped بدون سبب، و timeouts < 3%  
3) ui_action_coverage ≥ 30%  
4) flow_coverage ≥ 60% مع events حقيقية  
5) gap loop يعمل بالكامل خلال 24 ساعة  
6) semantic_delta يظهر في ≥ 50% من الجلسات  
7) proposals أسبوعية مع أثر واضح  
8) canary_evaluated > 0 أسبوعيًا + rollback تلقائي  
9) blocked < 30% أو مع بديل قياس  
10) سجل موحّد واضح في القرار والنتيجة والأثر

---

## 6) فصل مساري التحسين (Self vs Project)

### مسار 1: تحسين الوكيل (Self-Improvement Loop)
- تحديث السياسات والاستكشاف والتغطية والقياس.
- لا يغيّر ملفات المشروع الإنتاجية.

### مسار 2: تحسين المشروع (Project Loop)
- تطبيق الاقتراحات على ملفات المشروع.
- يبدأ فقط بعد تحقق DoD كامل.

---

## 7) دليل التنفيذ لأي مطوّر

### 7.1 مصادر الحقيقة
- `.bgl_core/logs/latest_report.json`
- `.bgl_core/config.yml`
- `storage/agent_flags.json`
- `.bgl_core/brain/master_verify.py`
- `.bgl_core/brain/guardian.py`
- `.bgl_core/brain/authority.py`
- `.bgl_core/brain/apply_proposal.py`

### 7.2 خطوات تنفيذ أي بند
1) سجل baseline من التقرير الحالي.
2) فعّل capability موجودة بدل بناء جديد.
3) نفّذ دفعة تغييرات تخدم capability واحدة فقط.
4) عند الحاجة للتشغيل: اطلب موافقة صريحة.
5) قارن المؤشرات قبل/بعد.

### 7.3 طريقة العمل (ترتيب ثابت لمنع التشعب)
1) **حدد البند + مخرجاته**: ما الذي يجب أن يظهر في التقرير/السجل؟
2) **تحقق من المسار الحالي**: هل البنية موجودة أم ناقصة؟
3) **نفّذ التفعيل بأقل تعديل ممكن**.
4) **وثّق الأثر المتوقع** في نفس البند (حتى لو لم تُشغّل فحوصات).

### 7.4 ربط تلقائي مع ما سبق
- كل بند يجب أن يُظهر أثره في:
  - `runtime_events` (حدث واضح).
  - `decision_traces` (سبب القرار).
  - `latest_report.json` (قراءة التقرير).

### 7.5 منع بناء جديد غير ضروري
- أي تعديل يجب أن يمر عبر سؤالين قبل التنفيذ:
  1) هل يوجد مكوّن موجود يمكن تفعيله بدل بناء جديد؟
  2) هل يوجد جزء من الخطة الحالية يغطي نفس الهدف؟

---

## 8) توضيح ختامي
بعد اكتمال هذه الخطة، سيصبح الوكيل قادرًا على **تشخيص ومعالجة معظم مشاكل المشروع تلقائيًا** عبر حلقة ذاتية.  
لكن بعض الحالات ستبقى تتطلب تدخلًا بشريًا (شبكات خارجية، قرارات معمارية كبيرة، بيانات إنتاج حساسة).
