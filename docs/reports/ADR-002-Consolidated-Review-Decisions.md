# ADR-002: Consolidated Review Decisions (Points 1โ8)

**ุงููุดุฑูุน**: BGL3  
**ุงููุทุงู**: Local / Single-User / Personal Device  
**ุงูุญุงูุฉ**: โ Accepted  
**ููุน ุงููุซููุฉ**: Consolidated ADR  
**ุงูุบุฑุถ**: ุชุซุจูุช ูุฑุงุฑุงุช ุงููุฑุงุฌุนุฉ ูุฅุบูุงู ุงูุฌุฏู  
**ุงูุชุงุฑูุฎ**: 2026-01-13

---

## ๐งญ ุงูุณูุงู ุงูุนุงู (Global Context)

### ุฎุตุงุฆุต ุงููุธุงู

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  BGL3 System Context                    โ
โ                                          โ
โ  โ ุงููุธุงู ูุนูู ูุญูููุง ููุท              โ
โ  โ ูุณุชุฎุฏู ูุงุญุฏ                         โ
โ                                          โ
โ  โ ูุง ููุฌุฏ:                            โ
โ     โข ุงุณุชุถุงูุฉ                           โ
โ     โข ุดุจูุฉ                               โ
โ     โข ุชุนุฏุฏ ูุณุชุฎุฏููู                      โ
โ     โข ูููุฐุฌ ุชูุฏูุฏ ุฎุงุฑุฌู                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

> **โ๏ธ ููู ุฌุฏุงู**: ุงููุฑุงุฑุงุช ุฃุฏูุงู ููููุฏุฉ ุจูุฐุง ุงูุณูุงู ููุท

---

## 1๏ธโฃ ุงูุฃูู (CSRF / Auth / Error Masking)

### ุงููุฑุงุฑ

```
๐ Out of Scope by Context
```

### ุงูุชุจุฑูุฑ

- ูุง ููุฌุฏ ุงุณุชูุฏุงู ูุงูุนู
- ูุง ููุฌุฏ ุณุทุญ ูุฌูู
- ุฃู ุงูุชุฑุงุถ ุฃููู ุฎุงุฑุฌู ุบูุฑ ููุทูู ูู ูุฐุง ุงูุณูุงู

### ุงูุชูุงุตูู

| ุงููุชุทูุจ | ุงูุญุงูุฉ | ุงูุณุจุจ |
|---------|--------|-------|
| CSRF Protection | โ ุฎุงุฑุฌ ุงููุทุงู | ูุง ููุฌุฏ attacker ูุญุชูู |
| Authentication | โ ุฎุงุฑุฌ ุงููุทุงู | ูุณุชุฎุฏู ูุงุญุฏ ููุท |
| Authorization | โ ุฎุงุฑุฌ ุงููุทุงู | ูุง ุชูุฌุฏ ุฃุฏูุงุฑ ูุชุนุฏุฏุฉ |
| Error Masking | โ ุฎุงุฑุฌ ุงููุทุงู | ูุง ุชูุฌุฏ ูุนูููุงุช ุญุณุงุณุฉ ูุนุฑุถุฉ |

### ุงูุญุงูุฉ

โ **ูุบูู ููุงุฆููุง**

**ุฅุนุงุฏุฉ ุงููุชุญ**: ููุท ุฅุฐุง ุชุบููุฑ ุงูุณูุงู (ูุดุฑ ุดุจูู / ุชุนุฏุฏ ูุณุชุฎุฏููู)

**ุงููุฑุฌุน**: [ADR-001](./ADR-001-Security-Controls-Out-of-Scope.md)

---

## 2๏ธโฃ ุงูุฃุฏุงุก โ N+1 / Sequential Queries

### ุงููุฑุงุฑ

```
๐ก ุชุญุณูู ุงุฎุชูุงุฑู ููุท
```

### ุงูุชุจุฑูุฑ

1. **ูุง ููุฌุฏ N+1 ุญุฑูููุง**
   - ุงูุงุณุชุนูุงูุงุช ูุชุณูุณูุฉ ููู ููุณุช ูู ุญููุฉ
   - ุนุฏุฏ ุงูุงุณุชุนูุงูุงุช ุซุงุจุช ููุญุฏูุฏ

2. **ุงูุฃุฏุงุก ุงูุญุงูู ููุจูู**
   - SQLite ูุญูู = ุณุฑูุน ุฌุฏุงู
   - ูุง ููุฌุฏ latency ุดุจูุฉ
   - ุงูุงุณุชุฌุงุจุฉ ููุฑูุฉ

3. **ูุง ููุฌุฏ ุถุบุท ุฃู ุญูู**
   - ูุณุชุฎุฏู ูุงุญุฏ
   - ุนูููุงุช ูุชุจุงุนุฏุฉ ุฒูููุงู
   - ูุง concurrent requests

### ูุซุงู ูู ุงูููุฏ

```php
// api/save-and-next.php - ุณุทุฑ 171-173
$supStmt = $db->prepare('SELECT official_name FROM suppliers WHERE id = ?');
$supStmt->execute([$supplierId]);
$newSupplier = $supStmt->fetchColumn();

// โ ูุฐุง ููุณ N+1 - ุฅูู ุงุณุชุนูุงู ูุงุญุฏ ูุญุฏุฏ
// โ N+1 ุงูุญูููู ูููู: foreach($items as $item) { query($item->id) }
```

### ุงูุญุงูุฉ

โ **ูุง ุชุนุฏูู ูุทููุจ**

**ุงููุฑุงูุจุฉ**: ุฅุฐุง ุชุญูู ุงููุธุงู ูู multi-user โ ุฅุนุงุฏุฉ ุชูููู

---

## 3๏ธโฃ ุงูููุงุฑุณ (Indexes)

### ุงููุฑุงุฑ

```
๐ก ููุจููุฉ ุญุงูููุง โ ุจูุง ุฅุถุงูุฉ
```

### ุงูุชุจุฑูุฑ

1. **ููุงุฑุณ ููุฌูุฏุฉ ูุนูููุง**

   ```sql
   -- storage/migrations/003_add_normalized_name_to_banks.sql
   CREATE INDEX IF NOT EXISTS idx_banks_normalized_name 
   ON banks(normalized_name);
   ```

2. **ูุง ููุฌุฏ ุจุทุก ููุญูุธ**
   - SQLite ุชุญุณูู ุงูุงุณุชุนูุงูุงุช ุชููุงุฆูุงู ููุฌุฏุงูู ุงูุตุบูุฑุฉ
   - ุญุฌู ุงูุจูุงูุงุช ุงูุญุงูู ุตุบูุฑ
   - ุงูุฃุฏุงุก ููุชุงุฒ

3. **ุบูุงุจ "ุงุณุชุฑุงุชูุฌูุฉ ููุงุฑุณ" ูุง ููุซู ูุดููุฉ ุงูุขู**
   - ูู production ุถุฎูุฉ โ ูุนู ูููุฉ
   - ูู single-user local โ ุงุฎุชูุงุฑูุฉ

### ุงูููุงุฑุณ ุงูููุชุฑุญุฉ (ูููุณุชูุจู)

```sql
-- ุนูุฏ ุงูุญุงุฌุฉ ููุท:
CREATE INDEX idx_guarantees_number ON guarantees(guarantee_number);
CREATE INDEX idx_decisions_guarantee ON guarantee_decisions(guarantee_id);
CREATE INDEX idx_decisions_status ON guarantee_decisions(status);
```

### ุงูุญุงูุฉ

โ **ูุฑุงูุจุฉ ููุท** - ูุง ุนูู ูุทููุจ ุงูุขู

---

## 4๏ธโฃ Foreign Keys / PRAGMA

### ุงููุฑุงุฑ

```
๐ก ุชุญุณูู ูุฒุงูุฉ ุงุฎุชูุงุฑู
```

### ุงูุชุจุฑูุฑ

1. **FK ูุนุฑููุฉ ููู ุบูุฑ ููุนููุฉ**

   ```sql
   -- migrations/004_remove_extra_columns.sql
   FOREIGN KEY (guarantee_id) REFERENCES guarantees(id) ON DELETE CASCADE
   -- โ ูุนุฑููุฉ ูู ุงูู schema
   -- โ ููู PRAGMA foreign_keys = OFF (ุงูุชุฑุงุถู)
   ```

2. **ุนุฏู ุงูุชูุนูู ูุง ูุณุจุจ ุฎูููุง**
   - ุงูููุฏ ูุญุชุฑู ุงูุนูุงูุงุช
   - ูุง ููุฌุฏ orphaned records
   - ุงูุชุญูู ููุฌูุฏ ุนูู ูุณุชูู Application

3. **ุงูุชูุนูู ูุญุณูู ุงููุฒุงูุฉ**
   - ุญูุงูุฉ ูู database-level
   - ูููู ููุณ ุดุฑุท ุชุดุบูู

### ุงูุชุญุณูู ุงูููุชุฑุญ

```php
// app/Support/Database.php - ุจุนุฏ ุงูุงุชุตุงู
public static function connect(): PDO {
    // ... existing code ...
    
    // โ ุงุฎุชูุงุฑู: ุชูุนูู Foreign Keys
    // $pdo->exec('PRAGMA foreign_keys = ON;');
    
    return $pdo;
}
```

### ุงูุญุงูุฉ

โ **ุงุฎุชูุงุฑู ุบูุฑ ููุฒู**

**ุงููุฑุงุฑ**: ูููู ุงูุชูุนูู ูู ุฃู ููุช ุฏูู ูุฎุงุทุฑ

---

## 5๏ธโฃ ุงูุตูุงูุฉ (TODOs / Logging / Inline Styles)

### ุงููุฑุงุฑ

```
๐ก ุฏูู ุชููู ุบูุฑ ูุคุซุฑ
```

### ุงูุชุจุฑูุฑ

#### ุฃ) TODOs (4 ููุงุถุน)

```php
// app/Services/Suggestions/ArabicLevelBSuggestions.php:343
// TODO: Implement audit logging
```

**ุงูุชุฃุซูุฑ**:

- โ ูุง ููุฌุฏ Bug
- โ ุงููุธุงู ูุนูู ุจุฏูููุง
- ๐ก ุชุญุณูู ูููุณุชูุจู ููุท

#### ุจ) Logging ุงูููุฑุท (70+ ููุถุน)

```javascript
console.log('โ๏ธ Preview update blocked...');
```

**ุงูุชุฃุซูุฑ**:

- โ ูููุฏ ููู debugging
- ๐ก ูููู ุชูุธููู ูุงุญูุงู
- โ ูุง ูุคุซุฑ ุนูู Production (ููุนุทูู ูู Build)

#### ุฌ) Inline Styles

```html
<div style="padding: 24px;">
```

**ุงูุชุฃุซูุฑ**:

- ๐ก ุชุฃุซูุฑ ุฐููู/ุชูุธููู ููุท
- โ ูุง ูุคุซุฑ ุนูู ุงูุฃุฏุงุก
- ๐ก refactoring ุงุฎุชูุงุฑู

### ุงูุญุงูุฉ

โ **ุชุญุณูู ุฌูุฏุฉ ุนูุฏ ุงูุญุงุฌุฉ**

**ูุง ุฃููููุฉ ุนุงููุฉ** - ูููู ูุนุงูุฌุชูุง ูู ุฃู ููุช

---

## 6๏ธโฃ ุงูุฃููุงุฏ ุงูููุชุฉ / Legacy

### ุงููุฑุงุฑ

```
๐ก ุฅุนุงุฏุฉ ุชุตููู - ูุง ุญุฐู ุฃุนูู
```

### ุงูุชุจุฑูุฑ

#### ุงููููุงุช ุงููุตูููุฉ ุฎุทุฃู ูู "ููุชุฉ"

```
โ dead_code_analysis.md ุงูุชุฑุญ ุญุฐู:
   - DualRun System
   - Cutover System
   
โ ุงููุงูุน:
   - ููุณุช ููุชุฉ - ุจู Legacy/Archived
   - ูุฏ ุชูุญุชุงุฌ ููููุงุฑูุฉ
   - ุงูุญุฐู ุงูุนุดูุงุฆู ุฎุทุฑ
```

#### ุงููุฑุงุฑ ุงูุตุญูุญ

| ุงูููู | ุงูุชุตููู ุงูุตุญูุญ | ุงูุฅุฌุฑุงุก |
|-------|-----------------|---------|
| `create_supplier.php` | ๐๏ธ ููุฑุฑ ูุนูุงู | โ ุชู ุงูุญุฐู |
| `XlsxReader.php` | ๐๏ธ ุบูุฑ ูุณุชุฎุฏู | โ ุชู ุงูุญุฐู |
| `DualRun/*` | ๐ฆ Legacy System | ุฃุฑุดูุฉ + ุชูุซูู |
| `Cutover/*` | ๐ฆ Legacy System | ุฃุฑุดูุฉ + ุชูุซูู |
| `ArabicLevelBSuggestions.php` | ๐ฆ Deprecated | ุฃุฑุดูุฉ + ุชูุซูู |

### ุงูุญุงูุฉ

โ **ุฃุฑุดูุฉ + ุชูุซูู**

**ุงูุญุฐู**: ุชู ุญุฐู `create_supplier.php` ู`XlsxReader.php`

---

## 7๏ธโฃ active_action (ุงูููุฏ โ ุงูุชูุซูู)

### ุงููุฑุงุฑ

```
๐ก ุชุญุณูู ุฑุจุท ุชูุซููู ููุท
```

### ุงูุชุจุฑูุฑ

#### ุงูููุทู ููุซู ูุนููุงู

```php
// api/extend.php - ุณุทุฑ 51-52
$gd->activeAction = 'extension';
$gd->activeActionSetAt = date('Y-m-d H:i:s');

// โ ุงูููุฏ ูุงุถุญ
// โ ADR-007 ููุฌูุฏ
// ๐ก ุงูุฑุจุท ุบูุฑ ูุจุงุดุฑ ููุท
```

#### ูุง ุฎูู ุณูููู

- ุงููุธุงู ูุนูู ููุง ูู ูุทููุจ
- ุงูููู ุตุญูุญุฉ
- ุงูุชูููุช ุฏููู

### ุงูุชุญุณูู ุงูููุชุฑุญ (ุงุฎุชูุงุฑู)

```php
// ุฅุถุงูุฉ ุฅุดุงุฑุฉ ุชูุซูููุฉ:

/**
 * Set active action for letter generation
 * @see ADR-007 for rationale
 */
$gd->activeAction = 'extension';
```

### ุงูุญุงูุฉ

โ **ุฅุถุงูุฉ ุฅุดุงุฑุงุช ุชูุซูููุฉ ุงุฎุชูุงุฑูุฉ**

**ูุง ุชุนุฏูู ุณูููู ูุทููุจ**

---

## 8๏ธโฃ ุฃุซุฑ ุงูุชุนุฏููุงุช ุนูู ุงูุฃุฏุงุก

### ุงููุฑุงุฑ

```
๐ข ูุง ููุฌุฏ ุฎุทุฑ ุฃุฏุงุก
```

### ุงูุชุจุฑูุฑ

#### ุชุญููู ุงูุชุนุฏููุงุช ุงูููุชุฑุญุฉ

| ุงูุชุนุฏูู | ุงูุชุฃุซูุฑ ุนูู ุงูุฃุฏุงุก | ุงูุฃูุงู |
|---------|---------------------|--------|
| ุฅุถุงูุฉ PRAGMA FK | ูุญุงูุฏ (microseconds) | โ ุขูู |
| ุฅุถุงูุฉ Indexes | +ุชุญุณูู ุทููู | โ ุขูู |
| ุชูุธูู TODOs | ูุญุงูุฏ ุชูุงูุงู | โ ุขูู |
| ุญุฐู Dead Code | +ุชุญุณูู (ุฃูู ุญุฌู) | โ ุขูู |
| ุฅุถุงูุฉ Comments | ูุญุงูุฏ ุชูุงูุงู | โ ุขูู |

#### ุงููุชูุฌุฉ

```
โ ุฌููุน ุงูุชุนุฏููุงุช ุงูููุชุฑุญุฉ:
   โข ุฅูุง ูุญุงูุฏุฉ
   โข ุฃู ูุญุณููุฉ ุจุดูู ุทููู
   โข ูุง ููุฌุฏ Regression ูุญุชูู
```

### ุงูุญุงูุฉ

โ **ุขูู ุจุงููุงูู**

**ูุง ููู ุนูู ุงูุฃุฏุงุก**

---

## โ ุงูุฎูุงุตุฉ ุงูููุงุฆูุฉ

### ุชูููู ุดุงูู

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ุงููุธุงู ุณููู ูู ุณูุงูู ุงูุญุงูู             โ
โ                                            โ
โ  โ ูุง ุชูุฌุฏ ููุงุท ุญุฑุฌุฉ                     โ
โ  โ ูุง ุชูุฌุฏ ูุชุทูุจุงุช ุฅูุฒุงููุฉ                โ
โ  ๐ก ุฃุบูุจ ุงูููุงุญุธุงุช ุชูุธูููุฉ ุฃู ุชุญุณูู ุฌูุฏุฉ  โ
โ  ๐ข ุงูุฃุฏุงุก ููุชุงุฒ                           โ
โ  ๐ ุงูุฃูู ููุงุณุจ ููุณูุงู                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ููุฎุต ุงููุฑุงุฑุงุช

| # | ุงูููุถูุน | ุงููุฑุงุฑ | ุงูุฃููููุฉ |
|---|---------|---------|----------|
| 1 | ุงูุฃูู | ๐ Out of Scope | ูุบูู |
| 2 | N+1 Queries | ๐ก ุงุฎุชูุงุฑู | ููุฎูุถุฉ |
| 3 | Indexes | ๐ก ูุฑุงูุจุฉ | ููุฎูุถุฉ |
| 4 | Foreign Keys | ๐ก ุงุฎุชูุงุฑู | ููุฎูุถุฉ |
| 5 | TODOs/Logging | ๐ก ุชุญุณูู ุฌูุฏุฉ | ููุฎูุถุฉ |
| 6 | Dead Code | ๐ก ุฃุฑุดูุฉ | ูุชูุณุทุฉ |
| 7 | Documentation | ๐ก ุงุฎุชูุงุฑู | ููุฎูุถุฉ |
| 8 | Performance | ๐ข ุขูู | - |

### ุงูุชูุตูุฉ ุงูุนุงูุฉ

```
๐ฏ ุงููุธุงู ุฌุงูุฒ ููุงุณุชุฎุฏุงู ููุง ูู
   
   ูุง ููุฌุฏ ุนูู ุฅูุฒุงูู
   
   ุงูุชุญุณููุงุช ุงูููุชุฑุญุฉ:
   โข ุงุฎุชูุงุฑูุฉ ุจุงููุงูู
   โข ูููู ุชุทุจูููุง ุชุฏุฑูุฌูุงู
   โข ูุง ุชุคุซุฑ ุนูู ุงูุชุดุบูู
```

---

## ๐ ุงูุชูููุนุงุช

**ุตุงุญุจ ุงููุฑุงุฑ**: Bakheet (Project Owner)  
**ุงููุฑุงุฌุน ุงูุชููู**: AI Analysis System  
**ุงูุชุงุฑูุฎ**: 2026-01-13  
**ุงูุญุงูุฉ ุงูููุงุฆูุฉ**: โ Accepted & Closed

---

## ๐ ุงููุฑุงุฌุน

- [ADR-001: Security Controls Out of Scope](./ADR-001-Security-Controls-Out-of-Scope.md)
- [Comprehensive Analysis Part 1](./reports/comprehensive_analysis_part1.md)
- [Comprehensive Analysis Part 2](./reports/comprehensive_analysis_part2.md)
- [Dead Code Analysis](./reports/dead_code_analysis.md)

---

**ุชู ุชุซุจูุช ุฌููุน ุงููุฑุงุฑุงุช ูุฅุบูุงู ุงูููุงุด ููุงุฆููุง** โ
